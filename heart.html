
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o M√£ QR H√¨nh Tr√°i Tim | Qu√† T·∫∑ng ƒê·ªôc ƒê√°o Cho Ng∆∞·ªùi Y√™u</title>
    <meta name="description" content="T·∫°o m√£ QR h√¨nh tr√°i tim mi·ªÖn ph√≠ - M√≥n qu√† √Ω nghƒ©a cho sinh nh·∫≠t, k·ª∑ ni·ªám v√† d·ªãp ƒë·∫∑c bi·ªát. T√πy ch·ªânh n·ªôi dung, th√™m h√¨nh n·ªÅn v√† icon ƒë·ªÉ t·∫°o QR ƒë·∫πp m·∫Øt, ƒë·ªôc ƒë√°o.">
    <meta name="keywords" content="m√£ QR h√¨nh tr√°i tim, qu√† t·∫∑ng ng∆∞·ªùi y√™u, QR tr√°i tim, qu√† sinh nh·∫≠t ƒë·ªôc ƒë√°o, qu√† t·∫∑ng k·ª∑ ni·ªám, t·∫°o QR online, qu√† t·∫∑ng √Ω nghƒ©a">
    <meta name="author" content="Nguy·ªÖn Tr√≠ To√°n">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://deargift.online/heartqr.html">
    <meta property="og:title" content="T·∫°o M√£ QR H√¨nh Tr√°i Tim - M√≥n Qu√† √ù Nghƒ©a Cho Ng∆∞·ªùi Y√™u">
    <meta property="og:description" content="T·∫°o m√£ QR h√¨nh tr√°i tim ƒë·ªôc ƒë√°o, t√πy ch·ªânh n·ªôi dung v√† h√¨nh n·ªÅn. M√≥n qu√† s·ªë ho√†n h·∫£o cho sinh nh·∫≠t, k·ª∑ ni·ªám v√† nh·ªØng d·ªãp ƒë·∫∑c bi·ªát.">
    <meta property="og:image" content="https://deargift.online/heartqr.html/logo.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://deargift.online/heartqr.html">
    <meta property="twitter:title" content="T·∫°o M√£ QR H√¨nh Tr√°i Tim - Qu√† T·∫∑ng ƒê·ªôc ƒê√°o">
    <meta property="twitter:description" content="T·∫°o QR code h√¨nh tr√°i tim - m√≥n qu√† √Ω nghƒ©a v√† s√°ng t·∫°o cho ng∆∞·ªùi y√™u, sinh nh·∫≠t v√† k·ª∑ ni·ªám ƒë·∫∑c bi·ªát.">
    <meta property="twitter:image" content="https://deargift.online/heartqr.html/logo.png">
    <link href="https://fonts.googleapis.com/css?family=Pacifico&display=swap" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css?family=Great+Vibes|Satisfy|Playball|Lobster|Montserrat|Dancing+Script&display=swap"
        rel="stylesheet">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GTY3RQNXTE"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-GTY3RQNXTE');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1512063810748748"
        crossorigin="anonymous"></script>
        

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1f1f2b 70%, #4c4f1a 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .container {
            /* background: rgb(255, 255, 255); */
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 90vw;
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        h1 {
            color: #ff4757;
            margin-bottom: 20px;
            font-size: clamp(1.5em, 4vw, 2.5em);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            font-family: 'Dancing Script', cursive;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: #ffffff;
            text-align: left;
            font-size: clamp(0.9em, 2.5vw, 1.1em);
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: clamp(14px, 3vw, 16px);
            transition: border-color 0.3s ease;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: clamp(14px, 3vw, 16px);
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #ff4757;
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.2);
        }

        button,
        .download-btn {
            background: linear-gradient(45deg, #0c0c0c, #b5b527);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 15px;
            font-size: clamp(14px, 3vw, 18px);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(106, 130, 251, 0.2);
            margin: 10px 5px;
        }

        button:hover,
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(252, 92, 125, 0.3);
        }

        .heart-container {
            position: relative;
            width: min(90vw, 400px);
            height: min(90vw, 400px);
            margin: 20px auto;
            display: none;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .qr-diamond {
            position: absolute;
            top: 53.7%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: min(36vw, 172px);
            height: min(36vw, 172px);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .qr-code {
            max-width: calc(min(36vw, 172px) - 10px);
            max-height: calc(min(36vw, 172px) - 10px);
        }

        .download-btn {
            background: linear-gradient(45deg, #ff4757, #ff6b6b);
        }

        .download-btn:hover {
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.4);
        }

        #captionDisplay {
            font-size: 2.5em; /* ƒê·ªìng b·ªô k√≠ch th∆∞·ªõc font */
            color: #d90429;
            word-break: break-word;
            margin-top: 13px;
            font-weight: bold;
        }

        /* Responsive breakpoints */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }

            .heart-container {
                width: min(85vw, 350px);
                height: min(85vw, 350px);
            }

            .qr-diamond {
                width: min(32vw, 140px);
                height: min(32vw, 140px);
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .heart-container {
                width: min(80vw, 300px);
                height: min(80vw, 300px);
            }

            .qr-diamond {
                width: min(27vw, 120px);
                height: min(27vw, 120px);
            }

            button {
                padding: 10px 20px;
                margin: 5px;
            }
        }

        @media (max-width: 320px) {
            .heart-container {
                width: 90vw;
                height: 90vw;
            }

            .qr-diamond {
                width: 25vw;
                height: 25vw;
            }
        }

        /* Landscape orientation adjustments */
        @media (orientation: landscape) and (max-height: 600px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                margin-bottom: 15px;
            }

            .input-group {
                margin-bottom: 15px;
            }

            .heart-container {
                margin: 15px auto;
                width: min(50vh, 300px);
                height: min(50vh, 300px);
            }
        }

        #bgPreviewContainer {
            background-color: #f8f9fa;
            background-image: linear-gradient(45deg, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%, #ddd),
                            linear-gradient(45deg, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%, #ddd);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }
        
        .custom-icon {
            box-sizing: border-box;
            border: 2px solid transparent;
        }
        
        .custom-icon.active {
            border: 2px dashed #4ecdc4;
        }
        
        .resize-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(78, 205, 196, 0.7);
            border-radius: 50%;
            z-index: 100;
            cursor: nwse-resize;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        /* Responsive cho modal custom background */
        @media (max-width: 768px) {
            #customBgModal > div {
                width: 95vw;
                padding: 1rem;
                max-height: 85vh;
            }
            
            .editor-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            #bgPreviewContainer {
                height: 250px;
            }
        }
        
        @media (max-width: 480px) {
            #customBgModal > div {
                width: 98vw;
                padding: 0.8rem;
            }
            
            .editor-btn {
                padding: 5px 10px;
                font-size: 0.75rem;
                margin-bottom: 8px;
            }
            
            #bgPreviewContainer {
                height: 200px;
            }
            
            #saveCustomBgBtn {
                padding: 10px 18px;
                font-size: 1rem;
            }
            
            h2 {
                font-size: 1.3rem;
                margin-bottom: 0.3rem;
            }
        }
        
        /* ƒêi·ªÅu ch·ªânh cho m√†n h√¨nh c·ª±c nh·ªè */
        @media (max-width: 360px) {
            .editor-btn {
                padding: 4px 8px;
                font-size: 0.7rem;
                width: 48%;
                margin: 1%;
            }
            
            #bgEditorArea > div > div {
                gap: 5px !important;
            }
            
            #saveCustomBgBtn {
                font-size: 0.9rem;
                padding: 8px 16px;
            }
        }
        
        /* CSS cho n·ªôi dung SEO */
        .seo-content, .more-info {
            text-align: left;
            max-width: 65vh;
            margin: 30px auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            color: #333;
        }
        
        .seo-content h1 {
            font-size: 1.8rem;
            color: #d90429;
            margin-bottom: 20px;
        }
        
        .seo-content h2, .more-info h2 {
            font-size: 1.4rem;
            color: #2b2d42;
            margin: 25px 0 15px;
            border-bottom: 2px solid #edf2f4;
            padding-bottom: 8px;
        }
        
        .seo-content p, .more-info p {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 15px;
            color: #2b2d42;
        }
        
        .seo-content ul {
            padding-left: 20px;
            margin-bottom: 20px;
        }
        
        .seo-content li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .info-card, .occasion, .faq-item {
            background-color: #f8f9fa;
            border-left: 4px solid #4ecdc4;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .info-card h3, .occasion h3, .faq-item h3 {
            color: #d90429;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        .faq-item h3 {
            font-size: 1.1rem;
            font-weight: normal;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .seo-content, .more-info {
                padding: 15px;
                margin: 20px 10px;
            }
            
            .seo-content h1 {
                font-size: 1.5rem;
            }
            
            .seo-content h2, .more-info h2 {
                font-size: 1.3rem;
            }
        }
    </style>
</head>

<body>
    <div id="google_translate_element"></div>
    <style>
      #google_translate_element {
        position: fixed;
        top: 18px;
        left: 18px;
        z-index: 99999;
        background: rgba(255,255,255,0.95);
        border-radius: 12px;
        box-shadow: 0 4px 18px #0002;
        padding: 6px 16px 6px 10px;
        min-width: 120px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      #google_translate_element * {
        font-family: 'Poppins', 'Arial', sans-serif !important;
        font-size: 15px !important;
      }
      .goog-te-gadget-simple {
        background: none !important;
        border: none !important;
        padding: 0 !important;
        margin: 0 !important;
        color: #222 !important;
      }
      .goog-te-gadget-icon {
        display: none !important;
      }
      .goog-te-menu-value {
        color: #4ecdc4 !important;
        font-weight: bold !important;
        padding-right: 10px !important;
      }
      .goog-te-arrow {
        color: #ff6b9d !important;
      }
      .VIpgJd-ZVi9od-ORHb-OEVmcd {
    display: none;
}
      @media (max-width: 600px) {
        #google_translate_element {
          top: 8px;
          right: 4px;
          padding: 4px 8px 4px 6px;
          min-width: 80px;
        }
        #google_translate_element * {
          font-size: 13px !important;
        }
      }
    </style>
    <div class="container">
        <!-- N√∫t t·∫°o QR h√¨nh ·∫£nh ·ªü g√≥c ph·∫£i tr√™n -->
        <button id="imgQrBtn" style="
            position: absolute;
            top: 18px;
            right: 18px;
            z-index: 1001;
            background: linear-gradient(45deg, #4ecdc4, #ff6b9d);
            color: #fff;
            border: none;
            border-radius: 18px;
            padding: 10px 18px;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 2px 10px #0002;
            cursor: pointer;
        ">T·∫°o QR c√≥ h√¨nh ·∫£nh</button>

        <h1>‚ù§Ô∏è T·∫°o M√£ QR H√¨nh Tr√°i Tim ‚ù§Ô∏è</h1>

        <div class="input-group">
            <label for="qrText">Nh·∫≠p link s·∫£n ph·∫©m c·ªßa b·∫°n v√†o ƒë√¢y:</label>
            <input type="text" id="qrText" placeholder="V√≠ d·ª•: https://example.com" value="">
        </div>

        <div class="input-group">
            <label for="captionText">Nh·∫≠p n·ªôi dung d∆∞·ªõi QR:</label>
            <input type="text" id="captionText" placeholder="Nh·∫≠p n·ªôi dung...">
        </div>

        <div class="input-group">
            <label for="fontSelect">Ch·ªçn font ch·ªØ:</label>
            <select id="fontSelect">
                <option value="'Dancing Script', cursive" selected>Dancing Script</option>
                <option value="Arial, sans-serif">Arial</option>
                <option value="'Times New Roman', Times, serif">Times New Roman</option>
                <option value="'Courier New', Courier, monospace">Courier New</option>
                <option value="'Comic Sans MS', cursive, sans-serif">Comic Sans MS</option>
                <option value="'Pacifico', cursive">Pacifico</option>
                <option value="'Great Vibes', cursive">Great Vibes</option>
                <option value="'Satisfy', cursive">Satisfy</option>
                <option value="'Playball', cursive">Playball</option>
                <option value="'Lobster', cursive">Lobster</option>
                <option value="'Montserrat', sans-serif">Montserrat</option>
            </select>
        </div>

        <button onclick="generateQR()">T·∫°o M√£ QR</button>

        <div class="heart-container" id="heartContainer">
            <div class="qr-diamond">
                <canvas id="qrCanvas" class="qr-code"></canvas>
            </div>
        </div>
        <div id="captionDisplay" style="width:100%;text-align:center;margin-top:18px;"></div>

        <button class="download-btn" id="downloadBtn" onclick="downloadImage()" style="display: none;">
            üíæ T·∫£i QR
        </button>
        <button class="download-btn" id="shareBtn" onclick="shareImage()" style="display: none; background: linear-gradient(45deg, #00b09b, #96c93d);">
            üì§ L∆∞u (iPhone/Android)
        </button>
        <button class="download-btn" id="customBgBtn" onclick="prepareCustomBackground()" style="display: none; background: linear-gradient(45deg, #1e3c72, #2a5298);">
            üñºÔ∏è T·∫°o QR tr√°i tim v·ªõi h√¨nh n·ªÅn
        </button>

        <!-- Th√™m ph·∫ßn modal cho custom background -->
        <div id="customBgModal" style="
            display: none;
            position: fixed;
            z-index: 10002;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        ">
            <div style="
                background: #fff;
                color: #222;
                border-radius: 18px;
                padding: 1.5rem;
                max-width: 95vw;
                width: 600px;
                box-shadow: 0 8px 32px #0005;
                text-align: center;
                position: relative;
                max-height: 90vh;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 15px;
            ">
                <button id="closeCustomBgModal" style="
                    position: absolute;
                    top: 12px; right: 16px;
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    color: #ff0202;
                    cursor: pointer;
                " title="ƒê√≥ng">&times;</button>
                
                <h2 style="color:#2a5298;margin-bottom:0.5rem;">T·∫°o h√¨nh n·ªÅn t√πy ch·ªânh</h2>
                <p class="note-text" style="color: rgba(255, 0, 0, 0.7); font-size: 14px; font-style: italic; margin-top: 8px; text-align: center;">*L∆∞u √Ω: n√™n ƒëi·ªÉu ch·ªânh v·ªã tr√≠ c·ªßa QR t·ªõi n∆°i c√≥ m√†u t·ªëi c·ªßa ·∫£nh n·ªÅn ƒë·ªÉ QR ƒë∆∞·ª£c r√µ v√† d·ªÖ qu√©t h∆°n</p>
                
                <div id="bgSelectArea">
                    <p style="margin-bottom:1rem;font-family: Verdana, Geneva, Tahoma, sans-serif;color: #16213e;">
                        Ch·ªçn m·ªôt ·∫£nh n·ªÅn t·ª´ thi·∫øt b·ªã c·ªßa b·∫°n:
                    </p>
                    <input type="file" id="bgImageInput" accept="image/*" style="
                        margin: 10px auto;
                        display: block;
                    ">
                </div>
                
                <div id="bgEditorArea" style="display: none; width: 100%;">
                    <div style="position: relative; margin: 0 auto; width: 100%; max-width: 500px;">
                        <div id="bgPreviewContainer" style="
                            position: relative;
                            width: 100%;
                            border: 2px dashed #ccc;
                            overflow: hidden;
                        ">
                            <img id="userBgImage" style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                object-fit: contain;
                                background-color: #f8f9fa;
                            ">
                            <img id="qrOverlayImage" style="
                                position: absolute;
                                width: 200px;
                                height: auto;
                                cursor: move;
                                user-select: none;
                                touch-action: none;
                            ">
                            <img id="selectedIcon" style="
                                position: absolute;
                                width: 80px;
                                height: auto;
                                cursor: move;
                                user-select: none;
                                touch-action: none;
                                display: none;
                            ">
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button id="zoomInBtn" class="editor-btn">
                                üîç+ Ph√≥ng to QR
                            </button>
                            <button id="zoomOutBtn" class="editor-btn">
                                üîç- Thu nh·ªè QR
                            </button>
                            <button id="centerQrBtn" class="editor-btn">
                                ‚åñ CƒÉn gi·ªØa
                            </button>
                            <button id="changeImageBtn" class="editor-btn" style="background: linear-gradient(45deg, #ff6b6b, #ff4757);">
                                üñºÔ∏è Ch·ªçn ·∫£nh n·ªÅn kh√°c
                            </button>
                            <button id="toggleIconsBtn" class="editor-btn" style="background: linear-gradient(45deg, #00cdac, #8ddad5);">
                                ‚ú® Ch·ªçn icon
                            </button>
                        </div>
                        
                        <!-- Ph·∫ßn ch·ªçn icon -->
                        <div id="iconsSelector" style="
                            margin-top: 15px;
                            display: none;
                            background-color: #f8f9fa;
                            border-radius: 10px;
                            padding: 15px;
                            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
                        ">
                            <h3 style="margin-bottom: 10px; font-size: 1rem; text-align: left;">Ch·ªçn icon:</h3>
                            <div style="
                                display: grid;
                                grid-template-columns: repeat(4, 1fr);
                                gap: 10px;
                                max-height: 200px;
                                overflow-y: auto;
                                padding: 5px;
                            ">
                                <img src="./icon_qr/icon_qr (1).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (2).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (3).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (4).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (5).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (6).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (7).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (8).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (9).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (10).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (11).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (12).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (13).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (14).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (15).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (16).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (17).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (18).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (19).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (21).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr.png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                                <button id="removeIconBtn" class="editor-btn" style="background: linear-gradient(45deg, #ff416c, #ff4b2b);">
                                    üóëÔ∏è X√≥a icon ƒë√£ ch·ªçn
                                </button>
                            </div>
                        </div>
                    </div>
                    <button id="saveCustomBgBtn" style="
                        background: linear-gradient(45deg, #1e3c72, #2a5298);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 15px;
                        font-size: clamp(14px, 3vw, 18px);
                        font-weight: bold;
                        cursor: pointer;
                        margin-top: 20px;
                        box-shadow: 0 5px 15px rgba(46, 49, 146, 0.3);
                    ">
                        üíæ L∆∞u ·∫£nh
                    </button>
                </div>
            </div>
        </div>

        <!-- N√∫t donate n·ªïi -->
        <button id="donateBtn" style="
  position: fixed;
  bottom: 32px;
  right: 32px;
  z-index: 9999;
  background: linear-gradient(45deg, #ff6b9d, #4ecdc4);
  color: white;
  border: none;
  border-radius: 50%;
  width: 56px;
  height: 56px;
  font-size: 2rem;
  box-shadow: 0 4px 24px #0004;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
">üíñ</button>

        <!-- Dialog donate -->
        <div id="donateDialog" style="
  display: none;
  position: fixed;
  z-index: 10000;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.45);
  align-items: center;
  justify-content: center;
">
            <div style="
    background: #fff;
    color: #222;
    border-radius: 18px;
    padding: 2rem 1.5rem 1.5rem 1.5rem;
    max-width: 90vw;
    width: 350px;
    box-shadow: 0 8px 32px #0005;
    text-align: center;
    position: relative;
  ">
                <button id="closeDonateDialog" style="
      position: absolute;
      top: 12px; right: 16px;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #888;
      cursor: pointer;
    " title="ƒê√≥ng">&times;</button>
                <h2 style="color:#ff6b9d;margin-bottom:0.5rem;">·ª¶ng h·ªô t√°c gi·∫£</h2>
                <p style="margin-bottom:1rem;
     font-family: Verdana, Geneva, Tahoma, sans-serif;color: #16213e;">Ch√†o b·∫°n, m√¨nh l√† Tr√≠ To√°n. N·∫øu b·∫°n th·∫•y d·ª± √°n
                    n√†y h·ªØu √≠ch, h√£y ·ªßng h·ªô m√¨nh ƒë·ªÉ m√¨nh c√≥ th√™m ƒë·ªông l·ª±c nh√©! C·∫£m ∆°n r·∫•t nhi·ªÅu üíó</p>
                <img src="./qr.png" alt="QR Donate"
                    style="width:180px;max-width:90%;border-radius:12px;box-shadow:0 2px 12px #0002;">
                <img src="./bank.png" alt="QR Donate"
                    style="width:180px;max-width:90%;border-radius:12px;box-shadow:0 2px 12px #0002;">
                <div style="margin: 1rem 0;">
                    <span id="copyBankNumber"
                        style="display:inline-block;padding:8px 18px;font-family: Verdana, Geneva, Tahoma, sans-serif;background:linear-gradient(45deg,#000000,#f4b2fa);color:#fff;font-weight:bold;border-radius:8px;cursor:pointer;user-select:all;font-size:1.1rem;">
                        12508248888
                    </span>
                    <span id="copySuccessMsg" style="display:none;margin-left:10px;color:#4ecdc4;font-weight:bold;">ƒê√£
                        copy!</span>
                </div>

            </div>
        </div>

        <!-- Modal t·∫°o QR h√¨nh ·∫£nh -->
        <div id="imgQrModal" style="
            display: none;
            position: fixed;
            z-index: 10001;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.45);
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        ">
            <div id="imgQrModalContent" style="
                background: #fff;
                color: #222;
                border-radius: 18px;
                padding: 2rem 1.5rem 1.5rem 1.5rem;
                max-width: 95vw;
                width: 350px;
                box-shadow: 0 8px 32px #0005;
                text-align: center;
                position: relative;
                max-height: 90vh;
                overflow-y: auto;
            ">
                <button id="closeImgQrModal" style="
                    position: absolute;
                    top: 12px; right: 16px;
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    color: #ff0202;
                    cursor: pointer;
                " title="ƒê√≥ng">&times;</button>
                <h2 style="color:#4ecdc4;margin-bottom:0.5rem;">T·∫°o QR c√≥ h√¨nh ·∫£nh</h2>
                <p style="margin-bottom:1rem;font-family: Verdana, Geneva, Tahoma, sans-serif;color: #16213e;">
                    N·∫øu b·∫°n mu·ªën c√≥ m·ªôt m√£ QR nh∆∞ th·∫ø n√†y:
                </p>
                <img src="./qrpro.png" alt="QR Pro Demo"
                    style="width:180px;max-width:90%;border-radius:12px;box-shadow:0 2px 12px #0002;margin-bottom:1rem;">
                <!-- ·∫¢nh QR thanh to√°n -->
                <div style="margin-bottom:1rem;font-size:1.1rem;color:#e63946;font-weight:bold;">
                    Gi√° c·ªßa QR c√≥ h√¨nh ·∫£nh l√† <span style="color:#ff6b9d;">20k</span>.<br>H√£y thanh to√°n v√†o s·ªë t√†i
                    kho·∫£n b√™n d∆∞·ªõi v√† nh·∫Øn tin qua Zalo cho t√¥i h√¨nh ·∫£nh v√† link b·∫°n c·∫ßn t·∫°o.
                </div>
                <img src="./qr.png" alt="QR Thanh to√°n"
                    style="width:160px;max-width:90%;border-radius:12px;box-shadow:0 2px 12px #0002;margin-bottom:1rem;">
                <div style="margin: 1rem 0;">
                    <span id="copyBankNumber2"
                        style="display:inline-block;padding:8px 18px;font-family: Verdana, Geneva, Tahoma, sans-serif;background:linear-gradient(45deg,#000000,#f4b2fa);color:#fff;font-weight:bold;border-radius:8px;cursor:pointer;user-select:all;font-size:1.1rem;">
                        12508248888
                    </span>
                    <span id="copySuccessMsg2" style="display:none;margin-left:10px;color:#4ecdc4;font-weight:bold;">ƒê√£
                        copy!</span>
                </div>
                <a href="https://zalo.me/0862613348" target="_blank" style="text-decoration:none;">
                    <button style="
                        background: linear-gradient(45deg, #0088ff, #00e676);
                        color: #fff;
                        border: none;
                        border-radius: 12px;
                        padding: 12px 24px;
                        font-size: 1.1rem;
                        font-weight: bold;
                        margin-top: 10px;
                        box-shadow: 0 2px 10px #0002;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        width: 100%;
                        max-width: 320px;
                    ">
                        <img src="./img/icons8-zalo-144.png" alt="Zalo"
                            style="width: 24px; height: 24px; vertical-align: middle;"> Chat qua Zalo
                    </button>
                </a>
            </div>
        </div>

        <!-- Dialog c·∫£m ∆°n -->
        <div id="thankDialog" style="
            display: none;
            position: fixed;
            z-index: 10003;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.45);
            align-items: center;
            justify-content: center;
        ">
            <div style="
                background: #fff;
                color: #222;
                border-radius: 18px;
                padding: 2rem 1.5rem 1.5rem 1.5rem;
                max-width: 90vw;
                width: 320px;
                box-shadow: 0 8px 32px #0005;
                text-align: center;
                position: relative;
            ">
                <button id="closeThankDialog" style="
                    position: absolute;
                    top: 5px; right: 5px;
                    background: none;
                    border: none;
                    font-size: 1rem;
                    color: #ff0202;
                    cursor: pointer;
                " title="ƒê√≥ng">&times;</button>
                <h2 style="color:#ff6b9d;margin-bottom:0.5rem;">Th√†nh c√¥ng!</h2>
                <p style="margin-bottom:1rem;font-family: Verdana, Geneva, Tahoma, sans-serif;color: #16213e;line-height: 1.5;">
                    C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng website!<br>
                    N·∫øu b·∫°n th·∫•y h·ªØu √≠ch, h√£y cho m√¨nh xin m·ªôt follow k√™nh TikTok <strong>To√°n</strong> ƒë·ªÉ m√¨nh c√≥ ƒë·ªông l·ª±c ph√°t tri·ªÉn web cho m·ªçi ng∆∞·ªùi nh√©.
                </p>
                <a href="https://www.tiktok.com/@iamtritoan?is_from_webapp=1&sender_device=pc" target="_blank" style="text-decoration:none;">
                    <button style="
                        background: linear-gradient(45deg, #000000, #fe2c55);
                        color: #fff;
                        border: none;
                        border-radius: 12px;
                        padding: 12px 24px;
                        font-size: 1.1rem;
                        font-weight: bold;
                        margin-top: 10px;
                        box-shadow: 0 2px 10px #0002;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        width: 100%;
                        max-width: 320px;
                        margin: 0 auto;
                    ">
                        <img src="./img/tik-tok.png" alt="TikTok" style="width: 24px; height: 24px; vertical-align: middle;"> 
                        Follow k√™nh TikTok
                    </button>
                </a>
            </div>
        </div>

        <script>
            // ƒê√≥ng modal khi click ra ngo√†i
            document.getElementById('imgQrModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            // Modal QR Pro
            document.getElementById('imgQrBtn').addEventListener('click', function () {
                document.getElementById('imgQrModal').style.display = 'flex';
            });
            document.getElementById('closeImgQrModal').addEventListener('click', function () {
                document.getElementById('imgQrModal').style.display = 'none';
            });
            // Copy s·ªë t√†i kho·∫£n trong modal QR Pro
            document.getElementById('copyBankNumber2').onclick = function () {
                navigator.clipboard.writeText('12508248888').then(function () {
                    document.getElementById('copySuccessMsg2').style.display = 'inline';
                    setTimeout(function () {
                        document.getElementById('copySuccessMsg2').style.display = 'none';
                    }, 1500);
                });
            };
            document.getElementById('donateBtn').addEventListener('click', function () {
                document.getElementById('donateDialog').style.display = 'flex';
            });
            document.getElementById('closeDonateDialog').addEventListener('click', function () {
                document.getElementById('donateDialog').style.display = 'none';
            });
            // Copy s·ªë t√†i kho·∫£n
            document.getElementById('copyBankNumber').onclick = function () {
                navigator.clipboard.writeText('12508248888').then(function () {
                    document.getElementById('copySuccessMsg').style.display = 'inline';
                    setTimeout(function () {
                        document.getElementById('copySuccessMsg').style.display = 'none';
                    }, 1500);
                });
            };
            
            // X·ª≠ l√Ω dialog c·∫£m ∆°n
            document.getElementById('closeThankDialog').addEventListener('click', function () {
                document.getElementById('thankDialog').style.display = 'none';
            });
            
            // ƒê√≥ng dialog c·∫£m ∆°n khi click ra ngo√†i
            document.getElementById('thankDialog').addEventListener('click', function (e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // Hi·ªÉn th·ªã dialog c·∫£m ∆°n khi ƒë√£ ho√†n th√†nh t·∫£i ·∫£nh
            function showThankDialog() {
                setTimeout(() => {
                    document.getElementById('thankDialog').style.display = 'flex';
                }, 500); // Hi·ªÉn th·ªã sau 0.5 gi√¢y ƒë·ªÉ cho ph√©p t·∫£i ·∫£nh ho√†n th√†nh
            }
        </script>
        <style>
            @media (max-width: 480px) {
                #imgQrModalContent {
                    width: 98vw !important;
                    padding: 1.2rem 0.5rem 1rem 0.5rem !important;
                }
            }

            /* CSS cho c√°c n√∫t ƒëi·ªÅu khi·ªÉn trong ph·∫ßn ch·ªânh s·ª≠a ·∫£nh n·ªÅn */
            .editor-btn {
                background: linear-gradient(45deg, #6a82fb, #fc5c7d);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 15px;
                font-size: 0.9rem;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            }
            
            .editor-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            }
            
            #bgPreviewContainer {
                background-color: #f8f9fa;
                background-image: linear-gradient(45deg, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%, #ddd),
                                linear-gradient(45deg, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%, #ddd);
                background-size: 20px 20px;
                background-position: 0 0, 10px 10px;
            }
            
            .custom-icon {
                box-sizing: border-box;
                border: 2px solid transparent;
            }
            
            .custom-icon.active {
                border: 2px dashed #4ecdc4;
            }
            
            .resize-handle {
                position: absolute;
                width: 20px;
                height: 20px;
                background: rgba(78, 205, 196, 0.7);
                border-radius: 50%;
                z-index: 100;
                cursor: nwse-resize;
                box-shadow: 0 0 5px rgba(0,0,0,0.3);
            }
            
            /* Responsive cho modal custom background */
            @media (max-width: 768px) {
                #customBgModal > div {
                    width: 95vw;
                    padding: 1rem;
                    max-height: 85vh;
                }
                
                .editor-btn {
                    padding: 6px 12px;
                    font-size: 0.8rem;
                }
                
                #bgPreviewContainer {
                    height: 250px;
                }
            }
            
            @media (max-width: 480px) {
                #customBgModal > div {
                    width: 98vw;
                    padding: 0.8rem;
                }
                
                .editor-btn {
                    padding: 5px 10px;
                    font-size: 0.75rem;
                    margin-bottom: 8px;
                }
                
                #bgPreviewContainer {
                    height: 200px;
                }
                
                #saveCustomBgBtn {
                    padding: 10px 18px;
                    font-size: 1rem;
                }
                
                h2 {
                    font-size: 1.3rem;
                    margin-bottom: 0.3rem;
                }
            }
            
            /* ƒêi·ªÅu ch·ªânh cho m√†n h√¨nh c·ª±c nh·ªè */
            @media (max-width: 360px) {
                .editor-btn {
                    padding: 4px 8px;
                    font-size: 0.7rem;
                    width: 48%;
                    margin: 1%;
                }
                
                #bgEditorArea > div > div {
                    gap: 5px !important;
                }
                
                #saveCustomBgBtn {
                    font-size: 0.9rem;
                    padding: 8px 16px;
                }
            }
        </style>
    </div>

    <script src="./detect-devtools.js"></script>
    <script type='text/javascript'>
        // Bypass for developers
        const keyName = 'key';
        const keyValue = '9ac7ec230e0e4513578f309d6d3579ad';

        // Handle via config
        DisableDevtool({
            tkName: keyName,
            md5: keyValue,
            interval: '100',
        });
    </script>
  <script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'vi',
        includedLanguages: [
          'en', // English
          'vi', // Vietnamese
          'id', // Indonesian
          'de', // German
          'fr', // French
          'th', // Thai
          'lo', // Lao
          'km', // Khmer (Cambodia)
          'ms', // Malay (Malaysia)
          'my', // Burmese (Myanmar)
          'zh-CN', // Chinese (Simplified)
          'zh-TW', // Chinese (Traditional)
          'ja', // Japanese
          'ko', // Korean
          'ru', // Russian
          'es', // Spanish
          'pt', // Portuguese
          'tl', // Filipino
          'hi', // Hindi
          'ar', // Arabic
          'bn', // Bengali
          'si', // Sinhala (Sri Lanka)
          'ne', // Nepali
          'mn', // Mongolian
          'pl', // Polish
          'it', // Italian
          'tr', // Turkish
          'la' // Latin (for completeness)
        ].join(','),
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
  </script>
  <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script>
        // Fallback n·∫øu CDN kh√¥ng ho·∫°t ƒë·ªông
        if (typeof qrcode === 'undefined') {
            // Th·ª≠ load t·ª´ CDN kh√°c
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js';
            script.onload = function() {
                console.log('QR code library loaded from fallback CDN');
            };
            script.onerror = function() {
                console.error('Failed to load QR code library from all sources');
            };
            document.head.appendChild(script);
        }
    </script>
    <script>
        // S·ª≠ d·ª•ng file image.png c√≥ s·∫µn
        const heartImageData = './imageheart.png';

        function updateCaptionDisplay() {
            const caption = document.getElementById('captionText').value;
            const font = document.getElementById('fontSelect').value;
            const captionDisplay = document.getElementById('captionDisplay');
            captionDisplay.textContent = caption;
            captionDisplay.style.fontFamily = font;
            captionDisplay.style.fontSize = '2.5em'; // TƒÉng k√≠ch th∆∞·ªõc t·ª´ 1.1em l√™n 1.6em
            captionDisplay.style.color = '#d90429';

            captionDisplay.style.marginTop = '13px';
            captionDisplay.style.marginBottom = '13px';

            captionDisplay.style.wordBreak = 'break-word';
        }

        function generateQR(options) {
            const suppressThank = !!(options && options.suppressThank);
            const text = document.getElementById('qrText').value.trim();

            if (!text) {
                alert('Vui l√≤ng nh·∫≠p n·ªôi dung ƒë·ªÉ t·∫°o m√£ QR!');
                return;
            }

            const canvas = document.getElementById('qrCanvas');
            const heartContainer = document.getElementById('heartContainer');
            const downloadBtn = document.getElementById('downloadBtn');
            const customBgBtn = document.getElementById('customBgBtn');
            const captionDisplay = document.getElementById('captionDisplay');

            try {
                // Ki·ªÉm tra xem th∆∞ vi·ªán QR code ƒë√£ ƒë∆∞·ª£c load ch∆∞a
                if (typeof qrcode === 'undefined') {
                    alert('Th∆∞ vi·ªán QR code ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau!');
                    return;
                }
                
                // Create QR code using qrcode-generator library
                const qr = qrcode(0, 'M');
                qr.addData(text);
                qr.make();

                // Get the module count and calculate responsive size
                const moduleCount = qr.getModuleCount();

                // ƒê·∫∑t k√≠ch th∆∞·ªõc QR ho√†n to√†n c·ªë ƒë·ªãnh - kh√¥ng thay ƒë·ªïi theo moduleCount
                let qrSize;
                if (window.innerWidth <= 480) {
                    qrSize = 122; // K√≠ch th∆∞·ªõc c·ªë ƒë·ªãnh cho mobile nh·ªè
                } else if (window.innerWidth <= 768) {
                    qrSize = 137; // K√≠ch th∆∞·ªõc c·ªë ƒë·ªãnh cho tablet
                } else {
                    qrSize = 386; // K√≠ch th∆∞·ªõc c·ªë ƒë·ªãnh cho desktop
                }

                // T√≠nh cellSize d·ª±a tr√™n qrSize c·ªë ƒë·ªãnh
                const cellSize = qrSize / moduleCount;

                // Save for download
                window._qrRenderInfo = {
                    qrSize
                };

                // Set canvas size
                canvas.width = qrSize;
                canvas.height = qrSize;

                const ctx = canvas.getContext('2d');

                // Clear canvas
                ctx.clearRect(0, 0, qrSize, qrSize);

                // Draw QR code v·ªõi m√†u ƒë·ªè gi·ªëng heart
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        if (qr.isDark(row, col)) {
                            // S·ª≠ d·ª•ng m√†u ƒë·ªè gi·ªëng v·ªõi heart (#ff4757)
                            const grad = ctx.createLinearGradient(
                                col * cellSize, row * cellSize,
                                (col + 1) * cellSize, (row + 1) * cellSize
                            );
                            grad.addColorStop(0, 'rgb(231,38,38)');
                            grad.addColorStop(0.5, 'rgb(231,38,38)');
                            grad.addColorStop(1, 'rgb(231,38,38)');
                            ctx.fillStyle = grad;

                            // V·∫Ω h√¨nh ch·ªØ nh·∫≠t ƒë∆°n gi·∫£n thay v√¨ roundRect ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi t·∫•t c·∫£ tr√¨nh duy·ªát
                            ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                        }
                    }
                }

                // ƒê·∫∑t n·ªÅn heart
                heartContainer.style.backgroundImage = `url(${heartImageData})`;
                heartContainer.style.display = 'block';
                downloadBtn.style.display = 'inline-block';
                document.getElementById('shareBtn').style.display = 'inline-block';
                customBgBtn.style.display = 'inline-block';

                // C·∫≠p nh·∫≠t ch√∫ th√≠ch
                const captionText = document.getElementById('captionText').value.trim();
                captionDisplay.innerText = captionText ? captionText : '';

                // Smooth scroll to result
                heartContainer.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
                
                // Hi·ªÉn th·ªã dialog c·∫£m ∆°n sau khi t·∫°o QR th√†nh c√¥ng (tr·ª´ khi ƒë∆∞·ª£c b·ªè qua)
                if (!suppressThank) {
                    setTimeout(() => {
                        document.getElementById('thankDialog').style.display = 'flex';
                    }, 800);
                }

            } catch (error) {
                console.error('QR Code generation error:', error);
                
                // Th·ª≠ t·∫°o QR code v·ªõi c·∫•u h√¨nh ƒë∆°n gi·∫£n h∆°n
                try {
                    const qr = qrcode(0, 'L'); // S·ª≠ d·ª•ng error correction level th·∫•p h∆°n
                    qr.addData(text);
                    qr.make();
                    
                    // Ti·∫øp t·ª•c v·ªõi logic hi·ªán t·∫°i
                    const moduleCount = qr.getModuleCount();
                    
                    let qrSize;
                    if (window.innerWidth <= 480) {
                        qrSize = 122;
                    } else if (window.innerWidth <= 768) {
                        qrSize = 137;
                    } else {
                        qrSize = 386;
                    }
                    
                    const cellSize = qrSize / moduleCount;
                    canvas.width = qrSize;
                    canvas.height = qrSize;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, qrSize, qrSize);
                    
                    // V·∫Ω QR code ƒë∆°n gi·∫£n
                    for (let row = 0; row < moduleCount; row++) {
                        for (let col = 0; col < moduleCount; col++) {
                            if (qr.isDark(row, col)) {
                                ctx.fillStyle = 'rgb(231,38,38)';
                                ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                            }
                        }
                    }
                    
                    // Hi·ªÉn th·ªã k·∫øt qu·∫£
                    heartContainer.style.backgroundImage = `url(${heartImageData})`;
                    heartContainer.style.display = 'block';
                    downloadBtn.style.display = 'inline-block';
                    document.getElementById('shareBtn').style.display = 'inline-block';
                    customBgBtn.style.display = 'inline-block';
                    
                    const captionText = document.getElementById('captionText').value.trim();
                    captionDisplay.innerText = captionText ? captionText : '';
                    
                    heartContainer.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    
                    if (!suppressThank) {
                        setTimeout(() => {
                            document.getElementById('thankDialog').style.display = 'flex';
                        }, 800);
                    }
                    
                } catch (fallbackError) {
                    console.error('Fallback QR generation also failed:', fallbackError);
                    alert('Kh√¥ng th·ªÉ t·∫°o m√£ QR. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i!');
                }
            }
        }

        function downloadImage() {
            const heartContainer = document.getElementById('heartContainer');
            const qrCanvas = document.getElementById('qrCanvas');

            // Tr∆∞·ªõc ti√™n, x·ª≠ l√Ω QR ƒë·ªÉ c√≥ n·ªÅn trong su·ªët
            const processedQR = document.createElement('canvas');
            const processedQRCtx = processedQR.getContext('2d');
            processedQR.width = qrCanvas.width;
            processedQR.height = qrCanvas.height;
            
            // V·∫Ω QR l√™n canvas t·∫°m
            processedQRCtx.drawImage(qrCanvas, 0, 0);
            
            // X·ª≠ l√Ω t·ª´ng pixel c·ªßa QR ƒë·ªÉ l√†m trong su·ªët ph·∫ßn n·ªÅn tr·∫Øng
            const qrData = processedQRCtx.getImageData(0, 0, processedQR.width, processedQR.height);
            const qrPixels = qrData.data;
            
            // X·ª≠ l√Ω n·ªÅn tr·∫Øng th√†nh trong su·ªët
            for (let i = 0; i < qrPixels.length; i += 4) {
                const red = qrPixels[i];
                const green = qrPixels[i + 1];
                const blue = qrPixels[i + 2];
                
                // Gi·∫£m ng∆∞·ª°ng ƒë·ªÉ b·∫Øt ƒë∆∞·ª£c nhi·ªÅu pixel tr·∫Øng/g·∫ßn tr·∫Øng h∆°n
                if (red > 180 && green > 180 && blue > 180) {
                    qrPixels[i + 3] = 0; // Alpha = 0 (trong su·ªët)
                }
                // TƒÉng c∆∞·ªùng m√†u ƒë·ªè cho QR
                else if (red > 100) {
                    qrPixels[i] = 231; // Red
                    qrPixels[i+1] = 38; // Green
                    qrPixels[i+2] = 38; // Blue
                }
            }
            
            // ƒê∆∞a d·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω tr·ªü l·∫°i canvas
            processedQRCtx.putImageData(qrData, 0, 0);

            // Create a canvas for the final image
            const finalCanvas = document.createElement('canvas');
            const ctx = finalCanvas.getContext('2d');

            // Load the heart image
            const heartImg = new Image();
            heartImg.onload = function () {
                // Set canvas to high resolution with padding for caption
                const scale = 2; // For better quality
                const captionHeight = 80; // Fixed height for caption area

                finalCanvas.width = heartImg.width * scale;
                finalCanvas.height = (heartImg.height + captionHeight) * scale;
                ctx.scale(scale, scale);

                // Draw heart background v·ªõi n·ªÅn trong su·ªët
                ctx.drawImage(heartImg, 0, 0);

                // Use fixed QR size based on image dimensions (not screen size)
                const qrSize = Math.min(heartImg.width, heartImg.height) * 0.40;

                // Calculate QR position (slightly above center)
                const centerX = heartImg.width / 2;
                const centerY = heartImg.height * 0.533;

                // Draw QR diamond with QR c√≥ n·ªÅn trong su·ªët
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(Math.PI / 4);

                // Draw QR ƒë√£ x·ª≠ l√Ω (kh√¥ng c√≥ n·ªÅn tr·∫Øng)
                ctx.drawImage(processedQR, -qrSize / 2, -qrSize / 2, qrSize, qrSize);
                ctx.restore();

                // Th√™m ch√∫ th√≠ch v√†o h√¨nh ·∫£nh - V·ªä TR√ç C·ªê ƒê·ªäNH
                const caption = document.getElementById('captionText').value;
                const font = document.getElementById('fontSelect').value;
                if (caption) {
                    ctx.save();

                    // Thi·∫øt l·∫≠p font v·ªõi k√≠ch th∆∞·ªõc l·ªõn h∆°n
                    const fontSize = Math.round(heartImg.width / 12); // TƒÉng c·ª° ch·ªØ (gi·∫£m s·ªë chia t·ª´ 20 xu·ªëng 12)
                    ctx.font = `bold ${fontSize}px ${font}`;
                    ctx.textAlign = 'center';
                    ctx.fillStyle = 'rgb(231,38,38)';
                    ctx.textBaseline = 'middle';

                    // V·ªä TR√ç C·ªê ƒê·ªäNH: lu√¥n c√°ch ƒë√°y ·∫£nh g·ªëc 40px
                    const textX = heartImg.width / 2; // Gi·ªØa theo chi·ªÅu ngang
                    const textY = heartImg.height + 40; // C√°ch ƒë√°y ·∫£nh g·ªëc 40px

                    // V·∫Ω ch·ªØ
                    ctx.fillText(caption, textX, textY, heartImg.width * 0.9);

                    ctx.restore();
                }

                // Download the final image
                finalCanvas.toBlob(function (blob) {
                    const url = URL.createObjectURL(blob);
                    // Hi·ªÉn th·ªã ·∫£nh cho ng∆∞·ªùi d√πng nh·∫•n gi·ªØ l∆∞u
                    let imgPreview = document.getElementById('imgPreview');
                    if (!imgPreview) {
                        imgPreview = document.createElement('img');
                        imgPreview.id = 'imgPreview';
                        imgPreview.style.maxWidth = '100%';
                        imgPreview.style.marginTop = '18px';
                        imgPreview.alt = '·∫¢nh QR tr√°i tim';
                        document.querySelector('.container').appendChild(imgPreview);
                    }
                    imgPreview.src = url;

                    // T·∫£i t·ª± ƒë·ªông nh∆∞ c≈© (n·∫øu tr√¨nh duy·ªát h·ªó tr·ª£)
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `qr-heart-${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    setTimeout(() => URL.revokeObjectURL(url), 2000);
                    
                    // Hi·ªÉn th·ªã dialog c·∫£m ∆°n sau khi t·∫£i xu·ªëng ho√†n t·∫•t
                    showThankDialog();
                }, 'image/png', 1.0);
            };

            heartImg.src = heartImageData;
        }

        // Chia s·∫ª/l∆∞u ·∫£nh b·∫±ng Web Share API (∆∞u ti√™n cho iPhone/Android)
        async function shareImage() {
            try {
                const qrCanvas = document.getElementById('qrCanvas');
                if (!qrCanvas || !qrCanvas.width) {
                    // N·∫øu ch∆∞a c√≥ QR th√¨ t·∫°o tr∆∞·ªõc, v√† b·ªè hi·ªán dialog c·∫£m ∆°n t·ª± ƒë·ªông
                    generateQR({ suppressThank: true });
                }

                // X·ª≠ l√Ω QR ƒë·ªÉ c√≥ n·ªÅn trong su·ªët (gi·ªëng downloadImage)
                const processedQR = document.createElement('canvas');
                const processedQRCtx = processedQR.getContext('2d');
                processedQR.width = qrCanvas.width;
                processedQR.height = qrCanvas.height;
                processedQRCtx.drawImage(qrCanvas, 0, 0);

                const qrData = processedQRCtx.getImageData(0, 0, processedQR.width, processedQR.height);
                const qrPixels = qrData.data;
                for (let i = 0; i < qrPixels.length; i += 4) {
                    const r = qrPixels[i];
                    const g = qrPixels[i + 1];
                    const b = qrPixels[i + 2];
                    if (r > 180 && g > 180 && b > 180) {
                        qrPixels[i + 3] = 0;
                    } else if (r > 100) {
                        qrPixels[i] = 231;
                        qrPixels[i + 1] = 38;
                        qrPixels[i + 2] = 38;
                    }
                }
                processedQRCtx.putImageData(qrData, 0, 0);

                // K·∫øt h·ª£p v√†o ·∫£nh tr√°i tim gi·ªëng downloadImage nh∆∞ng tr·∫£ ra blob ƒë·ªÉ chia s·∫ª
                const finalCanvas = document.createElement('canvas');
                const ctx = finalCanvas.getContext('2d');
                const heartImg = new Image();
                await new Promise((resolve, reject) => {
                    heartImg.onload = resolve;
                    heartImg.onerror = reject;
                    heartImg.src = heartImageData;
                });

                const scale = 2;
                const captionHeight = 80;
                finalCanvas.width = heartImg.width * scale;
                finalCanvas.height = (heartImg.height + captionHeight) * scale;
                ctx.scale(scale, scale);
                ctx.drawImage(heartImg, 0, 0);

                const qrSize = Math.min(heartImg.width, heartImg.height) * 0.40;
                const centerX = heartImg.width / 2;
                const centerY = heartImg.height * 0.533;
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(Math.PI / 4);
                ctx.drawImage(processedQR, -qrSize / 2, -qrSize / 2, qrSize, qrSize);
                ctx.restore();

                const caption = document.getElementById('captionText').value;
                const font = document.getElementById('fontSelect').value;
                if (caption) {
                    ctx.save();
                    const fontSize = Math.round(heartImg.width / 12);
                    ctx.font = `bold ${fontSize}px ${font}`;
                    ctx.textAlign = 'center';
                    ctx.fillStyle = 'rgb(231,38,38)';
                    ctx.textBaseline = 'middle';
                    const textX = heartImg.width / 2;
                    const textY = heartImg.height + 40;
                    ctx.fillText(caption, textX, textY, heartImg.width * 0.9);
                    ctx.restore();
                }

                const blob = await new Promise(resolve => finalCanvas.toBlob(resolve, 'image/png', 1.0));

                const file = new File([blob], `qr-heart-${Date.now()}.png`, { type: 'image/png' });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'QR Tr√°i tim',
                        text: caption || '·∫¢nh QR tr√°i tim'
                    });
                    showThankDialog();
                    return;
                }

                // Fallback: n·∫øu kh√¥ng h·ªó tr·ª£ share file, th·ª≠ share URL (√≠t tr√¨nh duy·ªát h·ªó tr·ª£ blob URL)
                if (navigator.share) {
                    const tmpUrl = URL.createObjectURL(blob);
                    try {
                        await navigator.share({ title: 'QR Tr√°i tim', url: tmpUrl });
                        showThankDialog();
                        return;
                    } catch (e) {
                        // b·ªè qua ƒë·ªÉ r∆°i xu·ªëng fallback ti·∫øp theo
                    } finally {
                        setTimeout(() => URL.revokeObjectURL(tmpUrl), 1500);
                    }
                }

                // Fallback cu·ªëi: d√πng c∆° ch·∫ø t·∫£i hi·ªán c√≥ v√† hi·ªÉn th·ªã preview ƒë·ªÉ ng∆∞·ªùi d√πng l∆∞u tay
                const url = URL.createObjectURL(blob);
                let imgPreview = document.getElementById('imgPreview');
                if (!imgPreview) {
                    imgPreview = document.createElement('img');
                    imgPreview.id = 'imgPreview';
                    imgPreview.style.maxWidth = '100%';
                    imgPreview.style.marginTop = '18px';
                    imgPreview.alt = '·∫¢nh QR tr√°i tim';
                    document.querySelector('.container').appendChild(imgPreview);
                }
                imgPreview.src = url;

                // Th√™m link t·∫£i nh∆∞ d·ª± ph√≤ng
                const a = document.createElement('a');
                a.href = url;
                a.download = `qr-heart-${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 2000);
                showThankDialog();
            } catch (err) {
                console.error('Share image error:', err);
                // N·∫øu c√≥ l·ªói, r∆°i v·ªÅ download ti√™u chu·∫©n
                downloadImage();
            }
        }

        // H√†m chu·∫©n b·ªã cho ch·ª©c nƒÉng t·∫°o h√¨nh n·ªÅn t√πy ch·ªânh
        function prepareCustomBackground() {
            // T·∫°o QR tr∆∞·ªõc n·∫øu ch∆∞a c√≥
            if (document.getElementById('heartContainer').style.display !== 'block') {
                generateQR();
                return;
            }
            
            // T·∫°o ·∫£nh QR tr√°i tim ƒë·ªÉ s·ª≠ d·ª•ng
            createQROverlayImage(function(qrImageUrl) {
                // L∆∞u URL ·∫£nh QR ƒë·ªÉ s·ª≠ d·ª•ng sau
                window._qrImageUrl = qrImageUrl;
                
                // M·ªü modal ch·ªçn ·∫£nh n·ªÅn
                document.getElementById('customBgModal').style.display = 'flex';
            });
        }
        
        // H√†m t·∫°o ·∫£nh QR tr√°i tim (t∆∞∆°ng t·ª± downloadImage nh∆∞ng ch·ªâ tr·∫£ v·ªÅ URL)
        function createQROverlayImage(callback) {
            const heartContainer = document.getElementById('heartContainer');
            const qrCanvas = document.getElementById('qrCanvas');
            
            // Tr∆∞·ªõc ti√™n, x·ª≠ l√Ω QR code ƒë·ªÉ lo·∫°i b·ªè n·ªÅn tr·∫Øng
            const processedQR = document.createElement('canvas');
            const processedQRCtx = processedQR.getContext('2d');
            
            // ƒê·∫∑t k√≠ch th∆∞·ªõc ƒë·ªÉ ph√π h·ª£p v·ªõi QR code
            processedQR.width = qrCanvas.width;
            processedQR.height = qrCanvas.height;
            
            // V·∫Ω QR l√™n canvas t·∫°m
            processedQRCtx.drawImage(qrCanvas, 0, 0);
            
            // X·ª≠ l√Ω t·ª´ng pixel c·ªßa QR ƒë·ªÉ l√†m trong su·ªët ph·∫ßn n·ªÅn tr·∫Øng
            const qrData = processedQRCtx.getImageData(0, 0, processedQR.width, processedQR.height);
            const data = qrData.data;
            
            // X·ª≠ l√Ω n·ªÅn tr·∫Øng th√†nh trong su·ªët
            for (let i = 0; i < data.length; i += 4) {
                const red = data[i];
                const green = data[i + 1];
                const blue = data[i + 2];
                
                // Gi·∫£m ng∆∞·ª°ng ƒë·ªÉ b·∫Øt ƒë∆∞·ª£c nhi·ªÅu pixel tr·∫Øng/g·∫ßn tr·∫Øng h∆°n
                if (red > 180 && green > 180 && blue > 180) {
                    data[i + 3] = 0; // Alpha = 0 (trong su·ªët)
                } 
                // TƒÉng c∆∞·ªùng m√†u ƒë·ªè cho QR
                else if (red > 100) {
                    data[i] = 231; // Red
                    data[i+1] = 38; // Green
                    data[i+2] = 38; // Blue
                }
            }
            
            // ƒê∆∞a d·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω tr·ªü l·∫°i canvas
            processedQRCtx.putImageData(qrData, 0, 0);
            
            // T·∫°o canvas cho ·∫£nh cu·ªëi c√πng
            const finalCanvas = document.createElement('canvas');
            const ctx = finalCanvas.getContext('2d');
            
            // Load ·∫£nh tr√°i tim
            const heartImg = new Image();
            heartImg.crossOrigin = 'Anonymous';
            
            heartImg.onload = function() {
                // Thi·∫øt l·∫≠p canvas v·ªõi ƒë·ªô ph√¢n gi·∫£i cao
                const scale = 2; // Cho ch·∫•t l∆∞·ª£ng t·ªët h∆°n
                const captionHeight = 80; // Chi·ªÅu cao c·ªë ƒë·ªãnh cho ph·∫ßn ch√∫ th√≠ch
                
                finalCanvas.width = heartImg.width * scale;
                finalCanvas.height = (heartImg.height + captionHeight) * scale;
                ctx.scale(scale, scale);
                
                // V·∫Ω n·ªÅn tr√°i tim
                ctx.drawImage(heartImg, 0, 0);
                
                // S·ª≠ d·ª•ng k√≠ch th∆∞·ªõc QR c·ªë ƒë·ªãnh d·ª±a tr√™n k√≠ch th∆∞·ªõc h√¨nh ·∫£nh
                const qrSize = Math.min(heartImg.width, heartImg.height) * 0.40;
                
                // T√≠nh to√°n v·ªã tr√≠ QR (h∆°i cao h∆°n t√¢m)
                const centerX = heartImg.width / 2;
                const centerY = heartImg.height * 0.533;
                
                // V·∫Ω QR ƒë√£ x·ª≠ l√Ω n·ªÅn trong su·ªët v√†o v·ªã tr√≠ ƒë√∫ng
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(Math.PI / 4);
                
                // S·ª≠ d·ª•ng ch·∫ø ƒë·ªô k·∫øt h·ª£p ƒë·ªÉ ch·ªâ v·∫Ω ph·∫ßn kh√¥ng trong su·ªët
                ctx.globalCompositeOperation = 'source-over';
                
                // V·∫Ω QR ƒë√£ x·ª≠ l√Ω n·ªÅn trong su·ªët (kh√¥ng c√≥ n·ªÅn tr·∫Øng n·ªØa)
                ctx.drawImage(processedQR, -qrSize / 2, -qrSize / 2, qrSize, qrSize);
                ctx.restore();
                
                // Th√™m ch√∫ th√≠ch v√†o h√¨nh ·∫£nh (v·ªã tr√≠ c·ªë ƒë·ªãnh)
                const caption = document.getElementById('captionText').value;
                const font = document.getElementById('fontSelect').value;
                if (caption) {
                    ctx.save();
                    
                    const fontSize = Math.round(heartImg.width / 12); // TƒÉng c·ª° ch·ªØ (gi·∫£m s·ªë chia t·ª´ 20 xu·ªëng 12)
                    ctx.font = `bold ${fontSize}px ${font}`;
                    ctx.textAlign = 'center';
                    ctx.fillStyle = 'rgb(231,38,38)';
                    ctx.textBaseline = 'middle';
                    
                    const textX = heartImg.width / 2;
                    const textY = heartImg.height + 40;
                    
                    ctx.fillText(caption, textX, textY, heartImg.width * 0.9);
                    
                    ctx.restore();
                }
                
                // Tr·∫£ v·ªÅ URL c·ªßa ·∫£nh
                const imageUrl = finalCanvas.toDataURL('image/png');
                callback(imageUrl);
            };
            
            heartImg.src = heartImageData;
        }
        
        // Kh·ªüi t·∫°o ch·ª©c nƒÉng ch·ªânh s·ª≠a ·∫£nh n·ªÅn
        function initBackgroundEditor() {
            const closeBtn = document.getElementById('closeCustomBgModal');
            const bgImageInput = document.getElementById('bgImageInput');
            const bgSelectArea = document.getElementById('bgSelectArea');
            const bgEditorArea = document.getElementById('bgEditorArea');
            const userBgImage = document.getElementById('userBgImage');
            const qrOverlayImage = document.getElementById('qrOverlayImage');
            const saveCustomBgBtn = document.getElementById('saveCustomBgBtn');
            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            const centerQrBtn = document.getElementById('centerQrBtn');
            const bgPreviewContainer = document.getElementById('bgPreviewContainer');
            
            // Bi·∫øn theo d√µi tr·∫°ng th√°i ch·ªânh s·ª≠a
            let qrScale = 1.0;
            let isDragging = false; // Bi·∫øn cho vi·ªác k√©o QR
            let offsetX = 0, offsetY = 0;
            
            // Bi·∫øn l∆∞u tr·ªØ tr·∫°ng th√°i icon
            let activeIcon = null; // Icon ƒëang ƒë∆∞·ª£c t∆∞∆°ng t√°c
            let icons = []; // M·∫£ng c√°c icon ƒë√£ th√™m
            let isIconDragging = false; // Bi·∫øn ri√™ng cho k√©o icon
            let isResizing = false;
            let iconStartX, iconStartY; // T·ªça ƒë·ªô b·∫Øt ƒë·∫ßu k√©o icon
            let startWidth, startHeight; // K√≠ch th∆∞·ªõc ban ƒë·∫ßu khi resize
            let lastTouches = null; // L∆∞u tr·∫°ng th√°i touch events tr∆∞·ªõc ƒë√≥
            
            // N√∫t hi·ªÉn th·ªã/·∫©n danh s√°ch icon
            const toggleIconsBtn = document.getElementById('toggleIconsBtn');
            const iconsSelector = document.getElementById('iconsSelector');
            
            toggleIconsBtn.addEventListener('click', function() {
                if (iconsSelector.style.display === 'none') {
                    iconsSelector.style.display = 'block';
                } else {
                    iconsSelector.style.display = 'none';
                }
            });
            
            // H√†m t·∫°o element icon m·ªõi
            function createIconElement(src) {
                const iconContainer = document.createElement('div');
                iconContainer.className = 'icon-container';
                iconContainer.style.position = 'absolute';
                iconContainer.style.display = 'inline-block';
                
                // L∆∞u gi√° tr·ªã xoay m·∫∑c ƒë·ªãnh
                iconContainer.rotation = 0;
                
                const icon = document.createElement('img');
                icon.src = src;
                icon.className = 'custom-icon';
                icon.style.width = '80px';
                icon.style.height = 'auto';
                icon.style.cursor = 'move';
                icon.style.userSelect = 'none';
                icon.style.touchAction = 'none';
                icon.style.transform = 'rotate(0deg)';
                
                // Th√™m n√∫t X ƒë·ªÉ x√≥a icon
                const deleteBtn = document.createElement('div');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.className = 'delete-icon-btn';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '-8px';
                deleteBtn.style.right = '-8px';
                deleteBtn.style.width = '20px';
                deleteBtn.style.height = '20px';
                deleteBtn.style.background = 'rgba(255, 0, 0, 0.8)';
                deleteBtn.style.color = 'white';
                deleteBtn.style.borderRadius = '50%';
                deleteBtn.style.textAlign = 'center';
                deleteBtn.style.lineHeight = '18px';
                deleteBtn.style.fontWeight = 'bold';
                deleteBtn.style.fontSize = '16px';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.style.zIndex = '101';
                deleteBtn.style.boxShadow = '0 0 3px rgba(0, 0, 0, 0.5)';
                
                // Th√™m n√∫t xoay icon
                const rotateBtn = document.createElement('div');
                rotateBtn.innerHTML = '&#8635;'; // Unicode k√Ω hi·ªáu xoay
                rotateBtn.className = 'rotate-icon-btn';
                rotateBtn.style.position = 'absolute';
                rotateBtn.style.top = '-8px';
                rotateBtn.style.left = '-8px';
                rotateBtn.style.width = '20px';
                rotateBtn.style.height = '20px';
                rotateBtn.style.background = 'rgba(0, 123, 255, 0.8)';
                rotateBtn.style.color = 'white';
                rotateBtn.style.borderRadius = '50%';
                rotateBtn.style.textAlign = 'center';
                rotateBtn.style.lineHeight = '20px';
                rotateBtn.style.fontWeight = 'bold';
                rotateBtn.style.fontSize = '16px';
                rotateBtn.style.cursor = 'pointer';
                rotateBtn.style.zIndex = '101';
                rotateBtn.style.boxShadow = '0 0 3px rgba(0, 0, 0, 0.5)';
                
                // X·ª≠ l√Ω s·ª± ki·ªán khi click v√†o n√∫t X
                deleteBtn.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // X√≥a icon kh·ªèi container v√† m·∫£ng icons
                    bgPreviewContainer.removeChild(iconContainer);
                    
                    // X√≥a kh·ªèi m·∫£ng icons
                    const index = icons.indexOf(iconContainer);
                    if (index > -1) {
                        icons.splice(index, 1);
                    }
                    
                    // N·∫øu icon ƒëang ƒë∆∞·ª£c ch·ªçn, ƒë·∫∑t l·∫°i activeIcon
                    if (activeIcon === iconContainer) {
                        activeIcon = null;
                    }
                });
                
                // X·ª≠ l√Ω s·ª± ki·ªán khi click v√†o n√∫t xoay
                rotateBtn.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Xoay th√™m 45 ƒë·ªô
                    iconContainer.rotation = (iconContainer.rotation + 45) % 360;
                    icon.style.transform = `rotate(${iconContainer.rotation}deg)`;
                });
                
                // Th√™m resize handle v√†o g√≥c ph·∫£i d∆∞·ªõi
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';
                resizeHandle.style.position = 'absolute';
                resizeHandle.style.width = '20px';
                resizeHandle.style.height = '20px';
                resizeHandle.style.bottom = '0';
                resizeHandle.style.right = '0';
                resizeHandle.style.cursor = 'nwse-resize';
                resizeHandle.style.background = 'rgba(0,0,0,0.2)';
                resizeHandle.style.borderRadius = '50%';
                resizeHandle.style.zIndex = '10';
                
                // Th√™m c√°c th√†nh ph·∫ßn v√†o container
                iconContainer.appendChild(icon);
                iconContainer.appendChild(deleteBtn);
                iconContainer.appendChild(rotateBtn);
                iconContainer.appendChild(resizeHandle);
                
                // Th√™m container v√†o bgPreviewContainer
                bgPreviewContainer.appendChild(iconContainer);
                
                // CƒÉn v·ªã tr√≠ icon ·ªü gi·ªØa container
                const containerRect = bgPreviewContainer.getBoundingClientRect();
                iconContainer.style.left = ((containerRect.width - 80) / 2) + 'px';
                iconContainer.style.top = ((containerRect.height - 80) / 2) + 'px';
                
                // Th√™m s·ª± ki·ªán t∆∞∆°ng t√°c
                icon.addEventListener('mousedown', (e) => startIconInteraction(e, iconContainer));
                icon.addEventListener('touchstart', (e) => startIconInteraction(e, iconContainer));
                
                resizeHandle.addEventListener('mousedown', (e) => startIconResize(e, iconContainer));
                resizeHandle.addEventListener('touchstart', (e) => startIconResize(e, iconContainer));
                
                return iconContainer;
            }
            
            // C·∫≠p nh·∫≠t v·ªã tr√≠ c·ªßa resize handle theo icon
            function updateResizeHandlePosition(iconContainer) {
                const icon = iconContainer.querySelector('.custom-icon');
                const handle = iconContainer.querySelector('.resize-handle');
                
                // Handle c√≥ v·ªã tr√≠ t∆∞∆°ng ƒë·ªëi so v·ªõi iconContainer n√™n kh√¥ng c·∫ßn ƒëi·ªÅu ch·ªânh
            }
            
            // X·ª≠ l√Ω khi ch·ªçn icon
            const iconOptions = document.querySelectorAll('.icon-option');
            
            iconOptions.forEach(iconOption => {
                iconOption.addEventListener('click', function() {
                    const iconContainer = createIconElement(this.src);
                    icons.push(iconContainer);
                    
                    // ƒê√°nh d·∫•u icon ƒë√£ ch·ªçn
                    iconOption.style.border = '3px solid #4ecdc4';
                    
                    // T·ª± ƒë·ªông b·ªè vi·ªÅn sau 1 gi√¢y
                    setTimeout(() => {
                        iconOption.style.border = 'none';
                    }, 1000);
                });
            });
            
            // X·ª≠ l√Ω khi nh·∫•n n√∫t x√≥a icon
            document.getElementById('removeIconBtn').addEventListener('click', function() {
                if (activeIcon) {
                    // X√≥a icon kh·ªèi container
                    bgPreviewContainer.removeChild(activeIcon);
                    
                    // X√≥a kh·ªèi m·∫£ng icons
                    const index = icons.indexOf(activeIcon);
                    if (index > -1) {
                        icons.splice(index, 1);
                    }
                    
                    activeIcon = null;
                } else {
                    alert('Vui l√≤ng ch·ªçn m·ªôt icon tr∆∞·ªõc!');
                }
            });
            
            // B·∫Øt ƒë·∫ßu t∆∞∆°ng t√°c v·ªõi icon (k√©o ho·∫∑c resize)
            function startIconInteraction(e, iconContainer) {
                e.preventDefault();
                e.stopPropagation();
                
                // Thi·∫øt l·∫≠p icon ƒëang ho·∫°t ƒë·ªông
                if (activeIcon && activeIcon !== iconContainer) {
                    // B·ªè vi·ªÅn icon tr∆∞·ªõc ƒë√≥
                    activeIcon.querySelector('.custom-icon').style.border = 'none';
                }
                
                activeIcon = iconContainer;
                activeIcon.querySelector('.custom-icon').style.border = '2px dashed #4ecdc4';
                activeIcon.style.zIndex = '100'; // ƒê∆∞a l√™n tr√™n c√πng
                
                isIconDragging = true;
                isResizing = false;
                isDragging = false; // ƒê·∫£m b·∫£o kh√¥ng k√©o QR
                
                if (e.type === 'mousedown') {
                    iconStartX = e.clientX;
                    iconStartY = e.clientY;
                } else {
                    iconStartX = e.touches[0].clientX;
                    iconStartY = e.touches[0].clientY;
                    
                    // L∆∞u tr·∫°ng th√°i touch cho pinch-zoom
                    if (e.touches.length === 2) {
                        lastTouches = e.touches;
                    }
                }
                
                // L∆∞u offset cho k√©o icon
                const rect = iconContainer.getBoundingClientRect();
                iconContainer.offsetX = iconStartX - rect.left;
                iconContainer.offsetY = iconStartY - rect.top;
                
            }
            
            // B·∫Øt ƒë·∫ßu thay ƒë·ªïi k√≠ch th∆∞·ªõc icon
            function startIconResize(e, iconContainer) {
                e.preventDefault();
                e.stopPropagation();
                
                activeIcon = iconContainer;
                activeIcon.querySelector('.custom-icon').style.border = '2px dashed #4ecdc4';
                
                isIconDragging = false;
                isResizing = true;
                isDragging = false; // ƒê·∫£m b·∫£o kh√¥ng k√©o QR
                
                if (e.type === 'mousedown') {
                    iconStartX = e.clientX;
                    iconStartY = e.clientY;
                } else {
                    iconStartX = e.touches[0].clientX;
                    iconStartY = e.touches[0].clientY;
                }
                
                // L∆∞u k√≠ch th∆∞·ªõc ban ƒë·∫ßu
                const rect = iconContainer.getBoundingClientRect();
                startWidth = rect.width;
                startHeight = rect.height;
                
                console.log('Start resize icon container');
            }
            
            // X·ª≠ l√Ω k√©o icon
            function dragIcon(clientX, clientY) {
                if (!activeIcon || !isIconDragging) return;
                
                const containerRect = bgPreviewContainer.getBoundingClientRect();
                
                // T√≠nh to√°n v·ªã tr√≠ m·ªõi - kh√¥ng gi·ªõi h·∫°n trong container
                let newLeft = clientX - containerRect.left - activeIcon.offsetX;
                let newTop = clientY - containerRect.top - activeIcon.offsetY;
                
                // C·∫≠p nh·∫≠t v·ªã tr√≠ kh√¥ng gi·ªõi h·∫°n
                activeIcon.style.left = newLeft + 'px';
                activeIcon.style.top = newTop + 'px';
                
            }
            
            // X·ª≠ l√Ω resize icon - lo·∫°i b·ªè gi·ªõi h·∫°n k√≠ch th∆∞·ªõc t·ªëi ƒëa
            function resizeIcon(clientX, clientY) {
                if (!activeIcon || !isResizing) return;
                
                const iconContainer = activeIcon;
                const icon = iconContainer.querySelector('.custom-icon');
                const rect = iconContainer.getBoundingClientRect();
                
                // T√≠nh to√°n k√≠ch th∆∞·ªõc m·ªõi d·ª±a tr√™n v·ªã tr√≠ con tr·ªè
                const width = Math.max(30, clientX - rect.left + 10);
                
                // C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc (kh√¥ng gi·ªõi h·∫°n k√≠ch th∆∞·ªõc t·ªëi ƒëa)
                icon.style.width = width + 'px';
                
            }
            
            // V·∫Ω t·∫•t c·∫£ c√°c icon khi l∆∞u ·∫£nh - c·∫≠p nh·∫≠t ƒë·ªÉ √°p d·ª•ng xoay
            function drawIcons(ctx, containerRect) {
                // Kh√¥ng c·∫ßn m·ªü r·ªông canvas - ph·∫ßn n√†o l√≤i ra ngo√†i s·∫Ω t·ª± ƒë·ªông b·ªã c·∫Øt
                
                icons.forEach(iconContainer => {
                    if (!iconContainer) return; // Skip n·∫øu icon kh√¥ng h·ª£p l·ªá
                    
                    try {
                        const icon = iconContainer.querySelector('.custom-icon');
                        if (!icon) return; // Skip n·∫øu kh√¥ng t√¨m th·∫•y icon
                        
                        const iconLeft = parseFloat(iconContainer.style.left) || 0;
                        const iconTop = parseFloat(iconContainer.style.top) || 0;
                        const rotation = iconContainer.rotation || 0;
                        
                        // L∆∞u tr·∫°ng th√°i context hi·ªán t·∫°i
                        ctx.save();
                        
                        // Di chuy·ªÉn ƒë·∫øn v·ªã tr√≠ trung t√¢m c·ªßa icon
                        const iconWidth = icon.offsetWidth;
                        const iconHeight = icon.offsetHeight;
                        const centerX = iconLeft + iconWidth/2;
                        const centerY = iconTop + iconHeight/2;
                        
                        // √Åp d·ª•ng xoay t·ª´ t√¢m c·ªßa icon
                        ctx.translate(centerX, centerY);
                        ctx.rotate(rotation * Math.PI / 180);
                        
                        // V·∫Ω icon (kh√¥ng v·∫Ω vi·ªÅn, n√∫t X v√† handle)
                        ctx.drawImage(icon, -iconWidth/2, -iconHeight/2, iconWidth, iconHeight);
                        
                        // Kh√¥i ph·ª•c tr·∫°ng th√°i context
                        ctx.restore();
                    } catch (err) {
                        console.error('L·ªói khi v·∫Ω icon:', err);
                    }
                });
            }
            
            // X√≥a b·ªè n√∫t "X√≥a icon ƒë√£ ch·ªçn" v√† thay ƒë·ªïi giao di·ªán ph·∫ßn ch·ªçn icon
            document.getElementById('iconsSelector').innerHTML = `
                <h3 style="margin-bottom: 10px; font-size: 1rem; text-align: left;">Ch·ªçn icon:</h3>
                <div style="
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 10px;
                    max-height: 200px;
                    overflow-y: auto;
                    padding: 5px;
                ">
                    <img src="./icon_qr/icon_qr (1).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (2).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (3).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (4).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (5).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (6).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (7).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (8).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (9).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (10).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (11).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (12).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (13).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (14).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (15).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (16).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (17).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (18).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (19).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (21).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr.png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                </div>
            `;
            
            // C·∫≠p nh·∫≠t c√°c s·ª± ki·ªán khi ch·ªçn icon t·ª´ danh s√°ch
            const updateIconSelectionEvents = function() {
                const iconOptions = document.querySelectorAll('.icon-option');
                
                iconOptions.forEach(iconOption => {
                    // X√≥a event listener c≈© n·∫øu c√≥
                    iconOption.replaceWith(iconOption.cloneNode(true));
                });
                
                // Th√™m l·∫°i event listener m·ªõi
                document.querySelectorAll('.icon-option').forEach(iconOption => {
                    iconOption.addEventListener('click', function() {
                        const iconContainer = createIconElement(this.src);
                        icons.push(iconContainer);
                        
                        // ƒê√°nh d·∫•u icon ƒë√£ ch·ªçn
                        iconOption.style.border = '3px solid #4ecdc4';
                        
                        // T·ª± ƒë·ªông b·ªè vi·ªÅn sau 1 gi√¢y
                        setTimeout(() => {
                            iconOption.style.border = 'none';
                        }, 1000);
                    });
                });
            };
            
            // C·∫≠p nh·∫≠t c√°c s·ª± ki·ªán sau khi thay ƒë·ªïi HTML
            updateIconSelectionEvents();
            
            // ƒê√≥ng modal
            closeBtn.addEventListener('click', function() {
                document.getElementById('customBgModal').style.display = 'none';
            });
            
            // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªçn file ·∫£nh n·ªÅn
            bgImageInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        userBgImage.src = e.target.result;
                        
                        // Hi·ªÉn th·ªã ph·∫ßn ch·ªânh s·ª≠a
                        bgSelectArea.style.display = 'none';
                        bgEditorArea.style.display = 'block';
                        
                        // ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc container theo t·ªâ l·ªá ·∫£nh
                        const img = new Image();
                        img.onload = function() {
                            // L·∫•y k√≠ch th∆∞·ªõc th·ª±c c·ªßa ·∫£nh
                            const imgWidth = this.width;
                            const imgHeight = this.height;
                            
                            // T√≠nh to√°n t·ªâ l·ªá ·∫£nh
                            const containerWidth = bgPreviewContainer.offsetWidth;
                            const aspectRatio = imgHeight / imgWidth;
                            
                            // ƒêi·ªÅu ch·ªânh chi·ªÅu cao c·ªßa container theo t·ªâ l·ªá ·∫£nh
                            bgPreviewContainer.style.height = (containerWidth * aspectRatio) + 'px';
                            
                            // Kh·ªüi t·∫°o h√¨nh QR overlay
                            qrOverlayImage.src = window._qrImageUrl;
                            
                            // ƒê·∫∑t v·ªã tr√≠ ban ƒë·∫ßu ·ªü gi·ªØa
                            setTimeout(centerQROverlay, 100);
                        };
                        img.src = e.target.result;
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            // Di chuy·ªÉn QR overlay b·∫±ng chu·ªôt/ch·∫°m
            qrOverlayImage.addEventListener('mousedown', startQrDrag);
            qrOverlayImage.addEventListener('touchstart', startQrDrag);
            
            // X·ª≠ l√Ω s·ª± ki·ªán di chuy·ªÉn QR ri√™ng bi·ªát
            function startQrDrag(e) {
                e.preventDefault();
                e.stopPropagation(); // NgƒÉn s·ª± ki·ªán lan truy·ªÅn
                
                isDragging = true;
                isIconDragging = false; // ƒê·∫£m b·∫£o kh√¥ng k√©o icon
                
                if (e.type === 'mousedown') {
                    iconStartX = e.clientX;
                    iconStartY = e.clientY;
                } else {
                    iconStartX = e.touches[0].clientX;
                    iconStartY = e.touches[0].clientY;
                }
                
                // L∆∞u v·ªã tr√≠ hi·ªán t·∫°i
                const rect = qrOverlayImage.getBoundingClientRect();
                offsetX = iconStartX - rect.left;
                offsetY = iconStartY - rect.top;
            }
            
            // H√†m k√©o QR
            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();
                e.stopPropagation(); // NgƒÉn s·ª± ki·ªán lan truy·ªÅn
                
                let clientX, clientY;
                
                if (e.type === 'mousemove') {
                    clientX = e.clientX;
                    clientY = e.clientY;
                } else {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                }
                
                const containerRect = bgPreviewContainer.getBoundingClientRect();
                
                // T√≠nh to√°n v·ªã tr√≠ m·ªõi - kh√¥ng gi·ªõi h·∫°n b·ªüi container
                let newLeft = clientX - containerRect.left - offsetX;
                let newTop = clientY - containerRect.top - offsetY;
                
                // C·∫≠p nh·∫≠t v·ªã tr√≠ kh√¥ng gi·ªõi h·∫°n
                qrOverlayImage.style.left = newLeft + 'px';
                qrOverlayImage.style.top = newTop + 'px';
            }
            
            // H√†m d·ª´ng k√©o QR
            function stopDrag() {
                isDragging = false;
            }

            document.addEventListener('mousemove', function(e) {
                // X·ª≠ l√Ω k√©o QR
                if (isDragging) {
                    drag(e);
                    return;
                }
                
                // X·ª≠ l√Ω k√©o icon
                if (isIconDragging && activeIcon) {
                    e.preventDefault();
                    dragIcon(e.clientX, e.clientY);
                    return;
                }
                
                // X·ª≠ l√Ω resize icon
                if (isResizing && activeIcon) {
                    e.preventDefault();
                    resizeIcon(e.clientX, e.clientY);
                    return;
                }
            });

            document.addEventListener('touchmove', function(e) {
                // X·ª≠ l√Ω k√©o QR
                if (isDragging) {
                    drag(e);
                    return;
                }
                
                if (!e.touches || e.touches.length === 0) return;
                
                const touch = e.touches[0];
                
                // X·ª≠ l√Ω k√©o icon
                if (isIconDragging && activeIcon) {
                    e.preventDefault();
                    dragIcon(touch.clientX, touch.clientY);
                    return;
                }
                
                // X·ª≠ l√Ω resize icon
                if (isResizing && activeIcon) {
                    e.preventDefault();
                    resizeIcon(touch.clientX, touch.clientY);
                    return;
                }
                
                // X·ª≠ l√Ω pinch-zoom
                if (e.touches.length === 2 && activeIcon) {
                    e.preventDefault();
                    const icon = activeIcon.querySelector('.custom-icon');
                    
                    // T√≠nh kho·∫£ng c√°ch gi·ªØa hai ng√≥n tay
                    const dist = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    
                    // N·∫øu ƒë√¢y l√† l·∫ßn ƒë·∫ßu ti√™n pinch-zoom
                    if (!lastTouches) {
                        lastTouches = {
                            dist: dist,
                            width: parseFloat(icon.style.width) || 80
                        };
                        return;
                    }
                    
                    // T√≠nh t·ª∑ l·ªá thay ƒë·ªïi
                    const scale = dist / lastTouches.dist;
                    const newWidth = Math.max(30, Math.min(lastTouches.width * scale, bgPreviewContainer.offsetWidth * 0.8));
                    
                    // C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc
                    icon.style.width = newWidth + 'px';
                    return;
                }
            });

            // X·ª≠ l√Ω k·∫øt th√∫c t∆∞∆°ng t√°c
            function stopInteraction() {
                isIconDragging = false;
                isResizing = false;
                // Kh√¥ng reset activeIcon ƒë·ªÉ gi·ªØ tr·∫°ng th√°i icon ƒëang ƒë∆∞·ª£c ch·ªçn
            }
            
            document.addEventListener('mouseup', function() {
                stopDrag();
                stopInteraction();
            });
            
            document.addEventListener('touchend', function() {
                stopDrag();
                stopInteraction();
                
                // Reset bi·∫øn lastTouches cho pinch-zoom
                lastTouches = null;
            });
            
            // N√∫t zoom in/out
            zoomInBtn.addEventListener('click', function() {
                qrScale += 0.1;
                updateQRScale();
            });
            
            zoomOutBtn.addEventListener('click', function() {
                if (qrScale > 0.5) {
                    qrScale -= 0.1;
                    updateQRScale();
                }
            });
            
            // N√∫t cƒÉn gi·ªØa
            centerQrBtn.addEventListener('click', centerQROverlay);
            
            // N√∫t ch·ªçn ·∫£nh kh√°c
            document.getElementById('changeImageBtn').addEventListener('click', function() {
                // ·∫®n ph·∫ßn ch·ªânh s·ª≠a v√† hi·ªÉn th·ªã l·∫°i ph·∫ßn ch·ªçn ·∫£nh
                bgEditorArea.style.display = 'none';
                bgSelectArea.style.display = 'block';
                
                // X√≥a gi√° tr·ªã c·ªßa input file ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i c√πng m·ªôt ·∫£nh n·∫øu mu·ªën
                document.getElementById('bgImageInput').value = '';
            });
            
            // N√∫t l∆∞u ·∫£nh
            saveCustomBgBtn.addEventListener('click', saveCustomBackground);
            
            // C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc QR
            function updateQRScale() {
                const baseSize = 200; // K√≠ch th∆∞·ªõc c∆° b·∫£n
                const newSize = baseSize * qrScale;
                qrOverlayImage.style.width = newSize + 'px';
            }
            
            // CƒÉn gi·ªØa QR
            function centerQROverlay() {
                const containerRect = bgPreviewContainer.getBoundingClientRect();
                const qrRect = qrOverlayImage.getBoundingClientRect();
                
                const left = (containerRect.width - qrRect.width) / 2;
                const top = (containerRect.height - qrRect.height) / 2;
                
                qrOverlayImage.style.left = left + 'px';
                qrOverlayImage.style.top = top + 'px';
            }
            
            // L∆∞u ·∫£nh ƒë√£ ch·ªânh s·ª≠a
            function saveCustomBackground() {
                // T·∫°o canvas ƒë·ªÉ k·∫øt h·ª£p ·∫£nh
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // L·∫•y k√≠ch th∆∞·ªõc container
                const containerRect = bgPreviewContainer.getBoundingClientRect();
                
                // Ch·ªâ l∆∞u ph·∫ßn trong container, ph·∫ßn l√≤i ra s·∫Ω b·ªã c·∫Øt
                const canvasWidth = containerRect.width;
                const canvasHeight = containerRect.height;
                
                // Thi·∫øt l·∫≠p k√≠ch th∆∞·ªõc canvas, v·ªõi t·ª∑ l·ªá x2 cho ƒë·ªô ph√¢n gi·∫£i cao
                canvas.width = canvasWidth * 2;
                canvas.height = canvasHeight * 2;
                
                // Scale canvas ƒë·ªÉ tƒÉng ƒë·ªô ph√¢n gi·∫£i
                ctx.scale(2, 2);
                
                // Thi·∫øt l·∫≠p v√πng c·∫Øt - ch·ªâ hi·ªÉn th·ªã ph·∫ßn trong container
                ctx.beginPath();
                ctx.rect(0, 0, canvasWidth, canvasHeight);
                ctx.clip();
                
                // V·∫Ω ·∫£nh n·ªÅn gi·ªØ nguy√™n t·ªâ l·ªá
                ctx.drawImage(userBgImage, 0, 0, containerRect.width, containerRect.height);
                
                // V·∫Ω QR overlay
                const left = parseFloat(qrOverlayImage.style.left) || 0;
                const top = parseFloat(qrOverlayImage.style.top) || 0;
                const width = qrOverlayImage.offsetWidth;
                const height = qrOverlayImage.offsetHeight;
                
                ctx.drawImage(qrOverlayImage, left, top, width, height);
                
                // V·∫Ω t·∫•t c·∫£ c√°c icon ƒë√£ th√™m
                drawIcons(ctx, containerRect);
                
                // T·∫°o URL v√† t·∫£i xu·ªëng
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `qr-custom-background-${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    setTimeout(() => URL.revokeObjectURL(url), 2000);
                    
                    // ƒê√≥ng modal sau khi t·∫£i
                    document.getElementById('customBgModal').style.display = 'none';
                    
                    // // Hi·ªÉn th·ªã th√¥ng b√°o
                    // alert('ƒê√£ l∆∞u ·∫£nh th√†nh c√¥ng!');
                    
               // Hi·ªÉn th·ªã dialog c·∫£m ∆°n sau khi t·∫£i xu·ªëng ho√†n t·∫•t
setTimeout(() => {
    document.getElementById('thankDialog').style.display = 'flex';
}, 500);
                }, 'image/png', 1.0);
            }
        }
        
        // C√°c h√†m x·ª≠ l√Ω DOM v√† s·ª± ki·ªán
        document.getElementById('captionText').addEventListener('input', updateCaptionDisplay);
        document.getElementById('fontSelect').addEventListener('change', updateCaptionDisplay);

        // Allow Enter key to generate QR
        document.getElementById('qrText').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                generateQR();
            }
        });

        // Auto load when page loads
        window.addEventListener('load', function () {
            const heartContainer = document.getElementById('heartContainer');
            heartContainer.style.backgroundImage = `url(${heartImageData})`;
            
            // Ki·ªÉm tra xem th∆∞ vi·ªán QR code ƒë√£ ƒë∆∞·ª£c load ch∆∞a
            if (typeof qrcode === 'undefined') {
                console.warn('QR code library not loaded yet, retrying...');
                // Th·ª≠ load l·∫°i th∆∞ vi·ªán n·∫øu c·∫ßn
                setTimeout(() => {
                    if (typeof qrcode === 'undefined') {
                        console.error('QR code library failed to load');
                    }
                }, 2000);
            }
        });

        // Load QR from URL parameter
        window.addEventListener('DOMContentLoaded', function () {
            // Kh·ªüi t·∫°o ch·ª©c nƒÉng ch·ªânh s·ª≠a ·∫£nh n·ªÅn
            initBackgroundEditor();
            
            // ƒê√≥ng modal khi click ra ngo√†i
            document.getElementById('customBgModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            const params = new URLSearchParams(window.location.search);
            const qr = params.get('qr');
            if (qr) {
                document.getElementById('qrText').value = qr;
                generateQR();
            }
            updateCaptionDisplay(); // Ensure captionDisplay uses the default font
        });

        // Handle window resize
        window.addEventListener('resize', function () {
            // Regenerate QR if it exists to maintain proper sizing
            const qrText = document.getElementById('qrText').value.trim();
            if (qrText && document.getElementById('heartContainer').style.display === 'block') {
                setTimeout(() => generateQR({ suppressThank: true }), 100);
            }
        });

        // X·ª≠ l√Ω s·ª± ki·ªán t∆∞∆°ng t√°c v·ªõi icon
        // (C√°c event listener ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong h√†m initBackgroundEditor)
    </script>
      
      <button id="toggleSeoBtn" style="margin-bottom:18px;padding:1px 2px;font-size:0.8em;border-radius:12px;color:#908d8d;font-weight:lighter;cursor:pointer;box-shadow:0 2px 8px #0002;background: none;">Xem th√™m v·ªÅ HeartQR</button>

      <section class="seo-content" style="display:none;">
        <h2>M√≥n Qu√† T·∫∑ng ƒê·ªôc ƒê√°o Cho D·ªãp ƒê·∫∑c Bi·ªát</h2>
        <p>Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi c√¥ng c·ª• <strong>t·∫°o m√£ QR h√¨nh tr√°i tim</strong> ƒë·ªôc ƒë√°o! T·∫°o ra nh·ªØng m√£ QR ƒë·∫πp m·∫Øt v√† √Ω nghƒ©a ƒë·ªÉ t·∫∑ng cho ng∆∞·ªùi th∆∞∆°ng, b·∫°n b√®, hay s·ª≠ d·ª•ng trong c√°c d·ªãp ƒë·∫∑c bi·ªát nh∆∞ sinh nh·∫≠t, k·ª∑ ni·ªám t√¨nh y√™u.</p>
        
        <p>ƒêang t√¨m ki·∫øm m·ªôt <strong>m√≥n qu√† sinh nh·∫≠t ƒë·ªôc ƒë√°o</strong>? M√£ QR h√¨nh tr√°i tim l√† l·ª±a ch·ªçn ho√†n h·∫£o, k·∫øt h·ª£p c√¥ng ngh·ªá hi·ªán ƒë·∫°i v·ªõi s·ª± l√£ng m·∫°n. B·∫°n c√≥ th·ªÉ t√πy ch·ªânh n·ªôi dung QR d·∫´n ƒë·∫øn:</p>
        <ul>
          <li>L·ªùi ch√∫c sinh nh·∫≠t ƒë·∫∑c bi·ªát</li>
          <li>Video k·ª∑ ni·ªám hai ng∆∞·ªùi</li>
          <li>Playlist nh·∫°c y√™u th√≠ch</li>
          <li>Album ·∫£nh k·ª∑ ni·ªám</li>
          <li>Link ƒë·∫∑t qu√† ho·∫∑c voucher</li>
        </ul>
        
        <h2>Qu√† T·∫∑ng Ng∆∞·ªùi Y√™u Trong C√°c D·ªãp ƒê·∫∑c Bi·ªát</h2>
        <p>Kh√¥ng ch·ªâ d√†nh cho sinh nh·∫≠t, <strong>QR tr√°i tim</strong> c√≤n l√† <strong>m√≥n qu√† t·∫∑ng ng∆∞·ªùi y√™u</strong> l√Ω t∆∞·ªüng cho Valentine, k·ª∑ ni·ªám quen nhau, hay b·∫•t k·ª≥ d·ªãp ƒë·∫∑c bi·ªát n√†o. H√£y t∆∞·ªüng t∆∞·ª£ng ni·ªÅm vui khi ng∆∞·ªùi ·∫•y qu√©t m√£ v√† kh√°m ph√° th√¥ng ƒëi·ªáp b·∫•t ng·ªù t·ª´ b·∫°n!</p>
      </section>
<section class="more-info" style="display:none;">
        <h2>T·∫°i Sao N√™n Ch·ªçn QR Tr√°i Tim L√†m Qu√† T·∫∑ng?</h2>
        
        <div class="info-card">
            <h3>√ù Nghƒ©a V√† ƒê·ªôc ƒê√°o</h3>
            <p>M√£ QR h√¨nh tr√°i tim k·∫øt h·ª£p c√¥ng ngh·ªá hi·ªán ƒë·∫°i v·ªõi t√¨nh c·∫£m, t·∫°o n√™n m√≥n qu√† ƒë·ªôc ƒë√°o m√† ng∆∞·ªùi nh·∫≠n kh√≥ qu√™n. Kh√°c v·ªõi nh·ªØng m√≥n qu√† th√¥ng th∆∞·ªùng, QR tr√°i tim mang ƒë·∫øn tr·∫£i nghi·ªám t∆∞∆°ng t√°c ƒë·∫∑c bi·ªát.</p>
        </div>
        
        <div class="info-card">
            <h3>Ti·∫øt Ki·ªám Chi Ph√≠</h3>
            <p>T·∫°o QR tr√°i tim ho√†n to√†n mi·ªÖn ph√≠ nh∆∞ng v·∫´n mang ƒë·∫øn gi√° tr·ªã tinh th·∫ßn l·ªõn. B·∫°n c√≥ th·ªÉ ƒë·∫ßu t∆∞ v√†o n·ªôi dung m√£ QR d·∫´n ƒë·∫øn (nh∆∞ video, ·∫£nh, l·ªùi nh·∫Øn) thay v√¨ chi ti·ªÅn cho nh·ªØng m√≥n qu√† ƒë·∫Øt ƒë·ªè.</p>
        </div>
        
        <div class="info-card">
            <h3>B·∫•t Ng·ªù V√† Ph·∫•n Kh√≠ch</h3>
            <p>Ng∆∞·ªùi nh·∫≠n s·∫Ω t√≤ m√≤ v√† ph·∫•n kh√≠ch khi qu√©t m√£ QR v√† kh√°m ph√° n·ªôi dung b·∫•t ng·ªù b√™n trong. ƒê√¢y l√† c√°ch tuy·ªát v·ªùi ƒë·ªÉ t·∫°o kho·∫£nh kh·∫Øc ƒë√°ng nh·ªõ trong c√°c d·ªãp ƒë·∫∑c bi·ªát.</p>
        </div>
        
        <h2>C√°ch S·ª≠ D·ª•ng QR Tr√°i Tim</h2>
        <p>Sau khi t·∫°o <strong>m√£ QR h√¨nh tr√°i tim</strong> c·ªßa b·∫°n, c√≥ nhi·ªÅu c√°ch ƒë·ªÉ t·∫≠n d·ª•ng:</p>
        <ul>
            <li>In v√† t·∫∑ng k√®m thi·ªáp sinh nh·∫≠t ho·∫∑c thi·ªáp ch√∫c m·ª´ng</li>
            <li>Chia s·∫ª qua tin nh·∫Øn trong c√°c d·ªãp ƒë·∫∑c bi·ªát</li>
            <li>ƒê·∫∑t trong khung ·∫£nh mini l√†m qu√† l∆∞u ni·ªám</li>
            <li>S·ª≠ d·ª•ng trong thi·∫øt k·∫ø thi·ªáp c∆∞·ªõi ho·∫∑c save-the-date</li>
            <li>T·∫°o sticker d√°n v√†o qu√† t·∫∑ng ho·∫∑c h·ªôp qu√†</li>
        </ul>
        
        <div class="faq">
            <h2>C√¢u H·ªèi Th∆∞·ªùng G·∫∑p</h2>
            
            <div class="faq-item">
                <h3>T√¥i c√≥ th·ªÉ l∆∞u m√£ QR tr√°i tim ƒë√£ t·∫°o kh√¥ng?</h3>
                <p>C√≥, b·∫°n c√≥ th·ªÉ t·∫£i xu·ªëng m√£ QR tr√°i tim d∆∞·ªõi d·∫°ng h√¨nh ·∫£nh PNG ch·∫•t l∆∞·ª£ng cao ƒë·ªÉ in ·∫•n ho·∫∑c chia s·∫ª.</p>
            </div>
            
            <div class="faq-item">
                <h3>M√£ QR c√≥ h·∫øt h·∫°n kh√¥ng?</h3>
                <p>M√£ QR kh√¥ng t·ª± h·∫øt h·∫°n, nh∆∞ng n·∫øu li√™n k·∫øt trong m√£ QR b·ªã v√¥ hi·ªáu h√≥a ho·∫∑c thay ƒë·ªïi, m√£ QR s·∫Ω kh√¥ng ho·∫°t ƒë·ªông ƒë∆∞·ª£c n·ªØa.</p>
            </div>
            
            <div class="faq-item">
                <h3>C√≥ th·ªÉ thay ƒë·ªïi m√†u s·∫Øc c·ªßa QR tr√°i tim kh√¥ng?</h3>
                <p>Hi·ªán t·∫°i, m√£ QR ƒë∆∞·ª£c t·∫°o v·ªõi m√†u ƒë·ªè ph√π h·ª£p v·ªõi h√¨nh tr√°i tim. Ch√∫ng t√¥i s·∫Ω c·∫≠p nh·∫≠t th√™m t√πy ch·ªçn m√†u s·∫Øc trong t∆∞∆°ng lai.</p>
            </div>
        </div>
    </section>

    <script>
    // ... existing code ...
    // Toggle SEO content
    document.getElementById('toggleSeoBtn').addEventListener('click', function() {
        var seo = document.querySelector('.seo-content');
        var more = document.querySelector('.more-info');
        var isShow = seo.style.display === 'block';
        seo.style.display = isShow ? 'none' : 'block';
        if(more) more.style.display = isShow ? 'none' : 'block';
        this.textContent = isShow ? 'Xem th√™m v·ªÅ HeartQR' : '·∫®n th√¥ng tin HeartQR';
    });
    // ... existing code ...
    </script>
</body>

</html>