
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Mã QR Hình Trái Tim | Quà Tặng Độc Đáo Cho Người Yêu</title>
    <meta name="description" content="Tạo mã QR hình trái tim miễn phí - Món quà ý nghĩa cho sinh nhật, kỷ niệm và dịp đặc biệt. Tùy chỉnh nội dung, thêm hình nền và icon để tạo QR đẹp mắt, độc đáo.">
    <meta name="keywords" content="mã QR hình trái tim, quà tặng người yêu, QR trái tim, quà sinh nhật độc đáo, quà tặng kỷ niệm, tạo QR online, quà tặng ý nghĩa">
    <meta name="author" content="Nguyễn Trí Toán">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://deargift.online/heartqr.html">
    <meta property="og:title" content="Tạo Mã QR Hình Trái Tim - Món Quà Ý Nghĩa Cho Người Yêu">
    <meta property="og:description" content="Tạo mã QR hình trái tim độc đáo, tùy chỉnh nội dung và hình nền. Món quà số hoàn hảo cho sinh nhật, kỷ niệm và những dịp đặc biệt.">
    <meta property="og:image" content="https://deargift.online/heartqr.html/logo.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://deargift.online/heartqr.html">
    <meta property="twitter:title" content="Tạo Mã QR Hình Trái Tim - Quà Tặng Độc Đáo">
    <meta property="twitter:description" content="Tạo QR code hình trái tim - món quà ý nghĩa và sáng tạo cho người yêu, sinh nhật và kỷ niệm đặc biệt.">
    <meta property="twitter:image" content="https://deargift.online/heartqr.html/logo.png">
    <link href="https://fonts.googleapis.com/css?family=Pacifico&display=swap" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css?family=Great+Vibes|Satisfy|Playball|Lobster|Montserrat|Dancing+Script&display=swap"
        rel="stylesheet">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GTY3RQNXTE"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-GTY3RQNXTE');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1512063810748748"
        crossorigin="anonymous"></script>
        

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1f1f2b 70%, #4c4f1a 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .container {
            /* background: rgb(255, 255, 255); */
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 90vw;
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        h1 {
            color: #ff4757;
            margin-bottom: 20px;
            font-size: clamp(1.5em, 4vw, 2.5em);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            font-family: 'Dancing Script', cursive;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: #ffffff;
            text-align: left;
            font-size: clamp(0.9em, 2.5vw, 1.1em);
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: clamp(14px, 3vw, 16px);
            transition: border-color 0.3s ease;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: clamp(14px, 3vw, 16px);
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #ff4757;
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.2);
        }

        button,
        .download-btn {
            background: linear-gradient(45deg, #0c0c0c, #b5b527);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 15px;
            font-size: clamp(14px, 3vw, 18px);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(106, 130, 251, 0.2);
            margin: 10px 5px;
        }

        button:hover,
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(252, 92, 125, 0.3);
        }

        .heart-container {
            position: relative;
            width: min(90vw, 400px);
            height: min(90vw, 400px);
            margin: 20px auto;
            display: none;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .qr-diamond {
            position: absolute;
            top: 53.7%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: min(36vw, 172px);
            height: min(36vw, 172px);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .qr-code {
            max-width: calc(min(36vw, 172px) - 10px);
            max-height: calc(min(36vw, 172px) - 10px);
        }

        .download-btn {
            background: linear-gradient(45deg, #ff4757, #ff6b6b);
        }

        .download-btn:hover {
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.4);
        }

        #captionDisplay {
            font-size: 2.5em; /* Đồng bộ kích thước font */
            color: #d90429;
            word-break: break-word;
            margin-top: 13px;
            font-weight: bold;
        }

        /* Responsive breakpoints */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }

            .heart-container {
                width: min(85vw, 350px);
                height: min(85vw, 350px);
            }

            .qr-diamond {
                width: min(32vw, 140px);
                height: min(32vw, 140px);
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .heart-container {
                width: min(80vw, 300px);
                height: min(80vw, 300px);
            }

            .qr-diamond {
                width: min(27vw, 120px);
                height: min(27vw, 120px);
            }

            button {
                padding: 10px 20px;
                margin: 5px;
            }
        }

        @media (max-width: 320px) {
            .heart-container {
                width: 90vw;
                height: 90vw;
            }

            .qr-diamond {
                width: 25vw;
                height: 25vw;
            }
        }

        /* Landscape orientation adjustments */
        @media (orientation: landscape) and (max-height: 600px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                margin-bottom: 15px;
            }

            .input-group {
                margin-bottom: 15px;
            }

            .heart-container {
                margin: 15px auto;
                width: min(50vh, 300px);
                height: min(50vh, 300px);
            }
        }

        #bgPreviewContainer {
            background-color: #f8f9fa;
            background-image: linear-gradient(45deg, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%, #ddd),
                            linear-gradient(45deg, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%, #ddd);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }
        
        .custom-icon {
            box-sizing: border-box;
            border: 2px solid transparent;
        }
        
        .custom-icon.active {
            border: 2px dashed #4ecdc4;
        }
        
        .resize-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(78, 205, 196, 0.7);
            border-radius: 50%;
            z-index: 100;
            cursor: nwse-resize;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        /* Responsive cho modal custom background */
        @media (max-width: 768px) {
            #customBgModal > div {
                width: 95vw;
                padding: 1rem;
                max-height: 85vh;
            }
            
            .editor-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            #bgPreviewContainer {
                height: 250px;
            }
        }
        
        @media (max-width: 480px) {
            #customBgModal > div {
                width: 98vw;
                padding: 0.8rem;
            }
            
            .editor-btn {
                padding: 5px 10px;
                font-size: 0.75rem;
                margin-bottom: 8px;
            }
            
            #bgPreviewContainer {
                height: 200px;
            }
            
            #saveCustomBgBtn {
                padding: 10px 18px;
                font-size: 1rem;
            }
            
            h2 {
                font-size: 1.3rem;
                margin-bottom: 0.3rem;
            }
        }
        
        /* Điều chỉnh cho màn hình cực nhỏ */
        @media (max-width: 360px) {
            .editor-btn {
                padding: 4px 8px;
                font-size: 0.7rem;
                width: 48%;
                margin: 1%;
            }
            
            #bgEditorArea > div > div {
                gap: 5px !important;
            }
            
            #saveCustomBgBtn {
                font-size: 0.9rem;
                padding: 8px 16px;
            }
        }
        
        /* CSS cho nội dung SEO */
        .seo-content, .more-info {
            text-align: left;
            max-width: 65vh;
            margin: 30px auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            color: #333;
        }
        
        .seo-content h1 {
            font-size: 1.8rem;
            color: #d90429;
            margin-bottom: 20px;
        }
        
        .seo-content h2, .more-info h2 {
            font-size: 1.4rem;
            color: #2b2d42;
            margin: 25px 0 15px;
            border-bottom: 2px solid #edf2f4;
            padding-bottom: 8px;
        }
        
        .seo-content p, .more-info p {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 15px;
            color: #2b2d42;
        }
        
        .seo-content ul {
            padding-left: 20px;
            margin-bottom: 20px;
        }
        
        .seo-content li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .info-card, .occasion, .faq-item {
            background-color: #f8f9fa;
            border-left: 4px solid #4ecdc4;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .info-card h3, .occasion h3, .faq-item h3 {
            color: #d90429;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        .faq-item h3 {
            font-size: 1.1rem;
            font-weight: normal;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .seo-content, .more-info {
                padding: 15px;
                margin: 20px 10px;
            }
            
            .seo-content h1 {
                font-size: 1.5rem;
            }
            
            .seo-content h2, .more-info h2 {
                font-size: 1.3rem;
            }
        }
    </style>
</head>

<body>
    <div id="google_translate_element"></div>
    <style>
      #google_translate_element {
        position: fixed;
        top: 18px;
        left: 18px;
        z-index: 99999;
        background: rgba(255,255,255,0.95);
        border-radius: 12px;
        box-shadow: 0 4px 18px #0002;
        padding: 6px 16px 6px 10px;
        min-width: 120px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      #google_translate_element * {
        font-family: 'Poppins', 'Arial', sans-serif !important;
        font-size: 15px !important;
      }
      .goog-te-gadget-simple {
        background: none !important;
        border: none !important;
        padding: 0 !important;
        margin: 0 !important;
        color: #222 !important;
      }
      .goog-te-gadget-icon {
        display: none !important;
      }
      .goog-te-menu-value {
        color: #4ecdc4 !important;
        font-weight: bold !important;
        padding-right: 10px !important;
      }
      .goog-te-arrow {
        color: #ff6b9d !important;
      }
      .VIpgJd-ZVi9od-ORHb-OEVmcd {
    display: none;
}
      @media (max-width: 600px) {
        #google_translate_element {
          top: 8px;
          right: 4px;
          padding: 4px 8px 4px 6px;
          min-width: 80px;
        }
        #google_translate_element * {
          font-size: 13px !important;
        }
      }
    </style>
    <div class="container">
        <!-- Nút tạo QR hình ảnh ở góc phải trên -->
        <button id="imgQrBtn" style="
            position: absolute;
            top: 18px;
            right: 18px;
            z-index: 1001;
            background: linear-gradient(45deg, #4ecdc4, #ff6b9d);
            color: #fff;
            border: none;
            border-radius: 18px;
            padding: 10px 18px;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 2px 10px #0002;
            cursor: pointer;
        ">Tạo QR có hình ảnh</button>

        <h1>❤️ Tạo Mã QR Hình Trái Tim ❤️</h1>

        <div class="input-group">
            <label for="qrText">Nhập link sản phẩm của bạn vào đây:</label>
            <input type="text" id="qrText" placeholder="Ví dụ: https://example.com" value="">
        </div>

        <div class="input-group">
            <label for="captionText">Nhập nội dung dưới QR:</label>
            <input type="text" id="captionText" placeholder="Nhập nội dung...">
        </div>

        <div class="input-group">
            <label for="fontSelect">Chọn font chữ:</label>
            <select id="fontSelect">
                <option value="'Dancing Script', cursive" selected>Dancing Script</option>
                <option value="Arial, sans-serif">Arial</option>
                <option value="'Times New Roman', Times, serif">Times New Roman</option>
                <option value="'Courier New', Courier, monospace">Courier New</option>
                <option value="'Comic Sans MS', cursive, sans-serif">Comic Sans MS</option>
                <option value="'Pacifico', cursive">Pacifico</option>
                <option value="'Great Vibes', cursive">Great Vibes</option>
                <option value="'Satisfy', cursive">Satisfy</option>
                <option value="'Playball', cursive">Playball</option>
                <option value="'Lobster', cursive">Lobster</option>
                <option value="'Montserrat', sans-serif">Montserrat</option>
            </select>
        </div>

        <button onclick="generateQR()">Tạo Mã QR</button>

        <div class="heart-container" id="heartContainer">
            <div class="qr-diamond">
                <canvas id="qrCanvas" class="qr-code"></canvas>
            </div>
        </div>
        <div id="captionDisplay" style="width:100%;text-align:center;margin-top:18px;"></div>

        <button class="download-btn" id="downloadBtn" onclick="downloadImage()" style="display: none;">
            💾 Tải QR
        </button>
        <button class="download-btn" id="shareBtn" onclick="shareImage()" style="display: none; background: linear-gradient(45deg, #00b09b, #96c93d);">
            📤 Lưu (iPhone/Android)
        </button>
        <button class="download-btn" id="customBgBtn" onclick="prepareCustomBackground()" style="display: none; background: linear-gradient(45deg, #1e3c72, #2a5298);">
            🖼️ Tạo QR trái tim với hình nền
        </button>

        <!-- Thêm phần modal cho custom background -->
        <div id="customBgModal" style="
            display: none;
            position: fixed;
            z-index: 10002;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        ">
            <div style="
                background: #fff;
                color: #222;
                border-radius: 18px;
                padding: 1.5rem;
                max-width: 95vw;
                width: 600px;
                box-shadow: 0 8px 32px #0005;
                text-align: center;
                position: relative;
                max-height: 90vh;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 15px;
            ">
                <button id="closeCustomBgModal" style="
                    position: absolute;
                    top: 12px; right: 16px;
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    color: #ff0202;
                    cursor: pointer;
                " title="Đóng">&times;</button>
                
                <h2 style="color:#2a5298;margin-bottom:0.5rem;">Tạo hình nền tùy chỉnh</h2>
                <p class="note-text" style="color: rgba(255, 0, 0, 0.7); font-size: 14px; font-style: italic; margin-top: 8px; text-align: center;">*Lưu ý: nên điểu chỉnh vị trí của QR tới nơi có màu tối của ảnh nền để QR được rõ và dễ quét hơn</p>
                
                <div id="bgSelectArea">
                    <p style="margin-bottom:1rem;font-family: Verdana, Geneva, Tahoma, sans-serif;color: #16213e;">
                        Chọn một ảnh nền từ thiết bị của bạn:
                    </p>
                    <input type="file" id="bgImageInput" accept="image/*" style="
                        margin: 10px auto;
                        display: block;
                    ">
                </div>
                
                <div id="bgEditorArea" style="display: none; width: 100%;">
                    <div style="position: relative; margin: 0 auto; width: 100%; max-width: 500px;">
                        <div id="bgPreviewContainer" style="
                            position: relative;
                            width: 100%;
                            border: 2px dashed #ccc;
                            overflow: hidden;
                        ">
                            <img id="userBgImage" style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                object-fit: contain;
                                background-color: #f8f9fa;
                            ">
                            <img id="qrOverlayImage" style="
                                position: absolute;
                                width: 200px;
                                height: auto;
                                cursor: move;
                                user-select: none;
                                touch-action: none;
                            ">
                            <img id="selectedIcon" style="
                                position: absolute;
                                width: 80px;
                                height: auto;
                                cursor: move;
                                user-select: none;
                                touch-action: none;
                                display: none;
                            ">
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button id="zoomInBtn" class="editor-btn">
                                🔍+ Phóng to QR
                            </button>
                            <button id="zoomOutBtn" class="editor-btn">
                                🔍- Thu nhỏ QR
                            </button>
                            <button id="centerQrBtn" class="editor-btn">
                                ⌖ Căn giữa
                            </button>
                            <button id="changeImageBtn" class="editor-btn" style="background: linear-gradient(45deg, #ff6b6b, #ff4757);">
                                🖼️ Chọn ảnh nền khác
                            </button>
                            <button id="toggleIconsBtn" class="editor-btn" style="background: linear-gradient(45deg, #00cdac, #8ddad5);">
                                ✨ Chọn icon
                            </button>
                        </div>
                        
                        <!-- Phần chọn icon -->
                        <div id="iconsSelector" style="
                            margin-top: 15px;
                            display: none;
                            background-color: #f8f9fa;
                            border-radius: 10px;
                            padding: 15px;
                            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
                        ">
                            <h3 style="margin-bottom: 10px; font-size: 1rem; text-align: left;">Chọn icon:</h3>
                            <div style="
                                display: grid;
                                grid-template-columns: repeat(4, 1fr);
                                gap: 10px;
                                max-height: 200px;
                                overflow-y: auto;
                                padding: 5px;
                            ">
                                <img src="./icon_qr/icon_qr (1).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (2).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (3).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (4).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (5).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (6).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (7).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (8).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (9).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (10).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (11).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (12).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (13).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (14).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (15).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (16).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (17).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (18).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (19).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr (21).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                                <img src="./icon_qr/icon_qr.png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                                <button id="removeIconBtn" class="editor-btn" style="background: linear-gradient(45deg, #ff416c, #ff4b2b);">
                                    🗑️ Xóa icon đã chọn
                                </button>
                            </div>
                        </div>
                    </div>
                    <button id="saveCustomBgBtn" style="
                        background: linear-gradient(45deg, #1e3c72, #2a5298);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 15px;
                        font-size: clamp(14px, 3vw, 18px);
                        font-weight: bold;
                        cursor: pointer;
                        margin-top: 20px;
                        box-shadow: 0 5px 15px rgba(46, 49, 146, 0.3);
                    ">
                        💾 Lưu ảnh
                    </button>
                </div>
            </div>
        </div>

        <!-- Nút donate nổi -->
        <button id="donateBtn" style="
  position: fixed;
  bottom: 32px;
  right: 32px;
  z-index: 9999;
  background: linear-gradient(45deg, #ff6b9d, #4ecdc4);
  color: white;
  border: none;
  border-radius: 50%;
  width: 56px;
  height: 56px;
  font-size: 2rem;
  box-shadow: 0 4px 24px #0004;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
">💖</button>

        <!-- Dialog donate -->
        <div id="donateDialog" style="
  display: none;
  position: fixed;
  z-index: 10000;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.45);
  align-items: center;
  justify-content: center;
">
            <div style="
    background: #fff;
    color: #222;
    border-radius: 18px;
    padding: 2rem 1.5rem 1.5rem 1.5rem;
    max-width: 90vw;
    width: 350px;
    box-shadow: 0 8px 32px #0005;
    text-align: center;
    position: relative;
  ">
                <button id="closeDonateDialog" style="
      position: absolute;
      top: 12px; right: 16px;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #888;
      cursor: pointer;
    " title="Đóng">&times;</button>
                <h2 style="color:#ff6b9d;margin-bottom:0.5rem;">Ủng hộ tác giả</h2>
                <p style="margin-bottom:1rem;
     font-family: Verdana, Geneva, Tahoma, sans-serif;color: #16213e;">Chào bạn, mình là Trí Toán. Nếu bạn thấy dự án
                    này hữu ích, hãy ủng hộ mình để mình có thêm động lực nhé! Cảm ơn rất nhiều 💗</p>
                <img src="./qr.png" alt="QR Donate"
                    style="width:180px;max-width:90%;border-radius:12px;box-shadow:0 2px 12px #0002;">
                <img src="./bank.png" alt="QR Donate"
                    style="width:180px;max-width:90%;border-radius:12px;box-shadow:0 2px 12px #0002;">
                <div style="margin: 1rem 0;">
                    <span id="copyBankNumber"
                        style="display:inline-block;padding:8px 18px;font-family: Verdana, Geneva, Tahoma, sans-serif;background:linear-gradient(45deg,#000000,#f4b2fa);color:#fff;font-weight:bold;border-radius:8px;cursor:pointer;user-select:all;font-size:1.1rem;">
                        12508248888
                    </span>
                    <span id="copySuccessMsg" style="display:none;margin-left:10px;color:#4ecdc4;font-weight:bold;">Đã
                        copy!</span>
                </div>

            </div>
        </div>

        <!-- Modal tạo QR hình ảnh -->
        <div id="imgQrModal" style="
            display: none;
            position: fixed;
            z-index: 10001;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.45);
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        ">
            <div id="imgQrModalContent" style="
                background: #fff;
                color: #222;
                border-radius: 18px;
                padding: 2rem 1.5rem 1.5rem 1.5rem;
                max-width: 95vw;
                width: 350px;
                box-shadow: 0 8px 32px #0005;
                text-align: center;
                position: relative;
                max-height: 90vh;
                overflow-y: auto;
            ">
                <button id="closeImgQrModal" style="
                    position: absolute;
                    top: 12px; right: 16px;
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    color: #ff0202;
                    cursor: pointer;
                " title="Đóng">&times;</button>
                <h2 style="color:#4ecdc4;margin-bottom:0.5rem;">Tạo QR có hình ảnh</h2>
                <p style="margin-bottom:1rem;font-family: Verdana, Geneva, Tahoma, sans-serif;color: #16213e;">
                    Nếu bạn muốn có một mã QR như thế này:
                </p>
                <img src="./qrpro.png" alt="QR Pro Demo"
                    style="width:180px;max-width:90%;border-radius:12px;box-shadow:0 2px 12px #0002;margin-bottom:1rem;">
                <!-- Ảnh QR thanh toán -->
                <div style="margin-bottom:1rem;font-size:1.1rem;color:#e63946;font-weight:bold;">
                    Giá của QR có hình ảnh là <span style="color:#ff6b9d;">20k</span>.<br>Hãy thanh toán vào số tài
                    khoản bên dưới và nhắn tin qua Zalo cho tôi hình ảnh và link bạn cần tạo.
                </div>
                <img src="./qr.png" alt="QR Thanh toán"
                    style="width:160px;max-width:90%;border-radius:12px;box-shadow:0 2px 12px #0002;margin-bottom:1rem;">
                <div style="margin: 1rem 0;">
                    <span id="copyBankNumber2"
                        style="display:inline-block;padding:8px 18px;font-family: Verdana, Geneva, Tahoma, sans-serif;background:linear-gradient(45deg,#000000,#f4b2fa);color:#fff;font-weight:bold;border-radius:8px;cursor:pointer;user-select:all;font-size:1.1rem;">
                        12508248888
                    </span>
                    <span id="copySuccessMsg2" style="display:none;margin-left:10px;color:#4ecdc4;font-weight:bold;">Đã
                        copy!</span>
                </div>
                <a href="https://zalo.me/0862613348" target="_blank" style="text-decoration:none;">
                    <button style="
                        background: linear-gradient(45deg, #0088ff, #00e676);
                        color: #fff;
                        border: none;
                        border-radius: 12px;
                        padding: 12px 24px;
                        font-size: 1.1rem;
                        font-weight: bold;
                        margin-top: 10px;
                        box-shadow: 0 2px 10px #0002;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        width: 100%;
                        max-width: 320px;
                    ">
                        <img src="./img/icons8-zalo-144.png" alt="Zalo"
                            style="width: 24px; height: 24px; vertical-align: middle;"> Chat qua Zalo
                    </button>
                </a>
            </div>
        </div>

        <!-- Dialog cảm ơn -->
        <div id="thankDialog" style="
            display: none;
            position: fixed;
            z-index: 10003;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.45);
            align-items: center;
            justify-content: center;
        ">
            <div style="
                background: #fff;
                color: #222;
                border-radius: 18px;
                padding: 2rem 1.5rem 1.5rem 1.5rem;
                max-width: 90vw;
                width: 320px;
                box-shadow: 0 8px 32px #0005;
                text-align: center;
                position: relative;
            ">
                <button id="closeThankDialog" style="
                    position: absolute;
                    top: 5px; right: 5px;
                    background: none;
                    border: none;
                    font-size: 1rem;
                    color: #ff0202;
                    cursor: pointer;
                " title="Đóng">&times;</button>
                <h2 style="color:#ff6b9d;margin-bottom:0.5rem;">Thành công!</h2>
                <p style="margin-bottom:1rem;font-family: Verdana, Geneva, Tahoma, sans-serif;color: #16213e;line-height: 1.5;">
                    Cảm ơn bạn đã sử dụng website!<br>
                    Nếu bạn thấy hữu ích, hãy cho mình xin một follow kênh TikTok <strong>Toán</strong> để mình có động lực phát triển web cho mọi người nhé.
                </p>
                <a href="https://www.tiktok.com/@iamtritoan?is_from_webapp=1&sender_device=pc" target="_blank" style="text-decoration:none;">
                    <button style="
                        background: linear-gradient(45deg, #000000, #fe2c55);
                        color: #fff;
                        border: none;
                        border-radius: 12px;
                        padding: 12px 24px;
                        font-size: 1.1rem;
                        font-weight: bold;
                        margin-top: 10px;
                        box-shadow: 0 2px 10px #0002;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        width: 100%;
                        max-width: 320px;
                        margin: 0 auto;
                    ">
                        <img src="./img/tik-tok.png" alt="TikTok" style="width: 24px; height: 24px; vertical-align: middle;"> 
                        Follow kênh TikTok
                    </button>
                </a>
            </div>
        </div>

        <script>
            // Đóng modal khi click ra ngoài
            document.getElementById('imgQrModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            // Modal QR Pro
            document.getElementById('imgQrBtn').addEventListener('click', function () {
                document.getElementById('imgQrModal').style.display = 'flex';
            });
            document.getElementById('closeImgQrModal').addEventListener('click', function () {
                document.getElementById('imgQrModal').style.display = 'none';
            });
            // Copy số tài khoản trong modal QR Pro
            document.getElementById('copyBankNumber2').onclick = function () {
                navigator.clipboard.writeText('12508248888').then(function () {
                    document.getElementById('copySuccessMsg2').style.display = 'inline';
                    setTimeout(function () {
                        document.getElementById('copySuccessMsg2').style.display = 'none';
                    }, 1500);
                });
            };
            document.getElementById('donateBtn').addEventListener('click', function () {
                document.getElementById('donateDialog').style.display = 'flex';
            });
            document.getElementById('closeDonateDialog').addEventListener('click', function () {
                document.getElementById('donateDialog').style.display = 'none';
            });
            // Copy số tài khoản
            document.getElementById('copyBankNumber').onclick = function () {
                navigator.clipboard.writeText('12508248888').then(function () {
                    document.getElementById('copySuccessMsg').style.display = 'inline';
                    setTimeout(function () {
                        document.getElementById('copySuccessMsg').style.display = 'none';
                    }, 1500);
                });
            };
            
            // Xử lý dialog cảm ơn
            document.getElementById('closeThankDialog').addEventListener('click', function () {
                document.getElementById('thankDialog').style.display = 'none';
            });
            
            // Đóng dialog cảm ơn khi click ra ngoài
            document.getElementById('thankDialog').addEventListener('click', function (e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // Hiển thị dialog cảm ơn khi đã hoàn thành tải ảnh
            function showThankDialog() {
                setTimeout(() => {
                    document.getElementById('thankDialog').style.display = 'flex';
                }, 500); // Hiển thị sau 0.5 giây để cho phép tải ảnh hoàn thành
            }
        </script>
        <style>
            @media (max-width: 480px) {
                #imgQrModalContent {
                    width: 98vw !important;
                    padding: 1.2rem 0.5rem 1rem 0.5rem !important;
                }
            }

            /* CSS cho các nút điều khiển trong phần chỉnh sửa ảnh nền */
            .editor-btn {
                background: linear-gradient(45deg, #6a82fb, #fc5c7d);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 15px;
                font-size: 0.9rem;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            }
            
            .editor-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            }
            
            #bgPreviewContainer {
                background-color: #f8f9fa;
                background-image: linear-gradient(45deg, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%, #ddd),
                                linear-gradient(45deg, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%, #ddd);
                background-size: 20px 20px;
                background-position: 0 0, 10px 10px;
            }
            
            .custom-icon {
                box-sizing: border-box;
                border: 2px solid transparent;
            }
            
            .custom-icon.active {
                border: 2px dashed #4ecdc4;
            }
            
            .resize-handle {
                position: absolute;
                width: 20px;
                height: 20px;
                background: rgba(78, 205, 196, 0.7);
                border-radius: 50%;
                z-index: 100;
                cursor: nwse-resize;
                box-shadow: 0 0 5px rgba(0,0,0,0.3);
            }
            
            /* Responsive cho modal custom background */
            @media (max-width: 768px) {
                #customBgModal > div {
                    width: 95vw;
                    padding: 1rem;
                    max-height: 85vh;
                }
                
                .editor-btn {
                    padding: 6px 12px;
                    font-size: 0.8rem;
                }
                
                #bgPreviewContainer {
                    height: 250px;
                }
            }
            
            @media (max-width: 480px) {
                #customBgModal > div {
                    width: 98vw;
                    padding: 0.8rem;
                }
                
                .editor-btn {
                    padding: 5px 10px;
                    font-size: 0.75rem;
                    margin-bottom: 8px;
                }
                
                #bgPreviewContainer {
                    height: 200px;
                }
                
                #saveCustomBgBtn {
                    padding: 10px 18px;
                    font-size: 1rem;
                }
                
                h2 {
                    font-size: 1.3rem;
                    margin-bottom: 0.3rem;
                }
            }
            
            /* Điều chỉnh cho màn hình cực nhỏ */
            @media (max-width: 360px) {
                .editor-btn {
                    padding: 4px 8px;
                    font-size: 0.7rem;
                    width: 48%;
                    margin: 1%;
                }
                
                #bgEditorArea > div > div {
                    gap: 5px !important;
                }
                
                #saveCustomBgBtn {
                    font-size: 0.9rem;
                    padding: 8px 16px;
                }
            }
        </style>
    </div>

    <script src="./detect-devtools.js"></script>
    <script type='text/javascript'>
        // Bypass for developers
        const keyName = 'key';
        const keyValue = '9ac7ec230e0e4513578f309d6d3579ad';

        // Handle via config
        DisableDevtool({
            tkName: keyName,
            md5: keyValue,
            interval: '100',
        });
    </script>
  <script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'vi',
        includedLanguages: [
          'en', // English
          'vi', // Vietnamese
          'id', // Indonesian
          'de', // German
          'fr', // French
          'th', // Thai
          'lo', // Lao
          'km', // Khmer (Cambodia)
          'ms', // Malay (Malaysia)
          'my', // Burmese (Myanmar)
          'zh-CN', // Chinese (Simplified)
          'zh-TW', // Chinese (Traditional)
          'ja', // Japanese
          'ko', // Korean
          'ru', // Russian
          'es', // Spanish
          'pt', // Portuguese
          'tl', // Filipino
          'hi', // Hindi
          'ar', // Arabic
          'bn', // Bengali
          'si', // Sinhala (Sri Lanka)
          'ne', // Nepali
          'mn', // Mongolian
          'pl', // Polish
          'it', // Italian
          'tr', // Turkish
          'la' // Latin (for completeness)
        ].join(','),
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
  </script>
  <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script>
        // Fallback nếu CDN không hoạt động
        if (typeof qrcode === 'undefined') {
            // Thử load từ CDN khác
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js';
            script.onload = function() {
                console.log('QR code library loaded from fallback CDN');
            };
            script.onerror = function() {
                console.error('Failed to load QR code library from all sources');
            };
            document.head.appendChild(script);
        }
    </script>
    <script>
        // Sử dụng file image.png có sẵn
        const heartImageData = './imageheart.png';

        function updateCaptionDisplay() {
            const caption = document.getElementById('captionText').value;
            const font = document.getElementById('fontSelect').value;
            const captionDisplay = document.getElementById('captionDisplay');
            captionDisplay.textContent = caption;
            captionDisplay.style.fontFamily = font;
            captionDisplay.style.fontSize = '2.5em'; // Tăng kích thước từ 1.1em lên 1.6em
            captionDisplay.style.color = '#d90429';

            captionDisplay.style.marginTop = '13px';
            captionDisplay.style.marginBottom = '13px';

            captionDisplay.style.wordBreak = 'break-word';
        }

        function generateQR(options) {
            const suppressThank = !!(options && options.suppressThank);
            const text = document.getElementById('qrText').value.trim();

            if (!text) {
                alert('Vui lòng nhập nội dung để tạo mã QR!');
                return;
            }

            const canvas = document.getElementById('qrCanvas');
            const heartContainer = document.getElementById('heartContainer');
            const downloadBtn = document.getElementById('downloadBtn');
            const customBgBtn = document.getElementById('customBgBtn');
            const captionDisplay = document.getElementById('captionDisplay');

            try {
                // Kiểm tra xem thư viện QR code đã được load chưa
                if (typeof qrcode === 'undefined') {
                    alert('Thư viện QR code chưa được tải. Vui lòng thử lại sau!');
                    return;
                }
                
                // Create QR code using qrcode-generator library
                const qr = qrcode(0, 'M');
                qr.addData(text);
                qr.make();

                // Get the module count and calculate responsive size
                const moduleCount = qr.getModuleCount();

                // Đặt kích thước QR hoàn toàn cố định - không thay đổi theo moduleCount
                let qrSize;
                if (window.innerWidth <= 480) {
                    qrSize = 122; // Kích thước cố định cho mobile nhỏ
                } else if (window.innerWidth <= 768) {
                    qrSize = 137; // Kích thước cố định cho tablet
                } else {
                    qrSize = 386; // Kích thước cố định cho desktop
                }

                // Tính cellSize dựa trên qrSize cố định
                const cellSize = qrSize / moduleCount;

                // Save for download
                window._qrRenderInfo = {
                    qrSize
                };

                // Set canvas size
                canvas.width = qrSize;
                canvas.height = qrSize;

                const ctx = canvas.getContext('2d');

                // Clear canvas
                ctx.clearRect(0, 0, qrSize, qrSize);

                // Draw QR code với màu đỏ giống heart
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        if (qr.isDark(row, col)) {
                            // Sử dụng màu đỏ giống với heart (#ff4757)
                            const grad = ctx.createLinearGradient(
                                col * cellSize, row * cellSize,
                                (col + 1) * cellSize, (row + 1) * cellSize
                            );
                            grad.addColorStop(0, 'rgb(231,38,38)');
                            grad.addColorStop(0.5, 'rgb(231,38,38)');
                            grad.addColorStop(1, 'rgb(231,38,38)');
                            ctx.fillStyle = grad;

                            // Vẽ hình chữ nhật đơn giản thay vì roundRect để tương thích với tất cả trình duyệt
                            ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                        }
                    }
                }

                // Đặt nền heart
                heartContainer.style.backgroundImage = `url(${heartImageData})`;
                heartContainer.style.display = 'block';
                downloadBtn.style.display = 'inline-block';
                document.getElementById('shareBtn').style.display = 'inline-block';
                customBgBtn.style.display = 'inline-block';

                // Cập nhật chú thích
                const captionText = document.getElementById('captionText').value.trim();
                captionDisplay.innerText = captionText ? captionText : '';

                // Smooth scroll to result
                heartContainer.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
                
                // Hiển thị dialog cảm ơn sau khi tạo QR thành công (trừ khi được bỏ qua)
                if (!suppressThank) {
                    setTimeout(() => {
                        document.getElementById('thankDialog').style.display = 'flex';
                    }, 800);
                }

            } catch (error) {
                console.error('QR Code generation error:', error);
                
                // Thử tạo QR code với cấu hình đơn giản hơn
                try {
                    const qr = qrcode(0, 'L'); // Sử dụng error correction level thấp hơn
                    qr.addData(text);
                    qr.make();
                    
                    // Tiếp tục với logic hiện tại
                    const moduleCount = qr.getModuleCount();
                    
                    let qrSize;
                    if (window.innerWidth <= 480) {
                        qrSize = 122;
                    } else if (window.innerWidth <= 768) {
                        qrSize = 137;
                    } else {
                        qrSize = 386;
                    }
                    
                    const cellSize = qrSize / moduleCount;
                    canvas.width = qrSize;
                    canvas.height = qrSize;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, qrSize, qrSize);
                    
                    // Vẽ QR code đơn giản
                    for (let row = 0; row < moduleCount; row++) {
                        for (let col = 0; col < moduleCount; col++) {
                            if (qr.isDark(row, col)) {
                                ctx.fillStyle = 'rgb(231,38,38)';
                                ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                            }
                        }
                    }
                    
                    // Hiển thị kết quả
                    heartContainer.style.backgroundImage = `url(${heartImageData})`;
                    heartContainer.style.display = 'block';
                    downloadBtn.style.display = 'inline-block';
                    document.getElementById('shareBtn').style.display = 'inline-block';
                    customBgBtn.style.display = 'inline-block';
                    
                    const captionText = document.getElementById('captionText').value.trim();
                    captionDisplay.innerText = captionText ? captionText : '';
                    
                    heartContainer.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    
                    if (!suppressThank) {
                        setTimeout(() => {
                            document.getElementById('thankDialog').style.display = 'flex';
                        }, 800);
                    }
                    
                } catch (fallbackError) {
                    console.error('Fallback QR generation also failed:', fallbackError);
                    alert('Không thể tạo mã QR. Vui lòng kiểm tra kết nối internet và thử lại!');
                }
            }
        }

        function downloadImage() {
            const heartContainer = document.getElementById('heartContainer');
            const qrCanvas = document.getElementById('qrCanvas');

            // Trước tiên, xử lý QR để có nền trong suốt
            const processedQR = document.createElement('canvas');
            const processedQRCtx = processedQR.getContext('2d');
            processedQR.width = qrCanvas.width;
            processedQR.height = qrCanvas.height;
            
            // Vẽ QR lên canvas tạm
            processedQRCtx.drawImage(qrCanvas, 0, 0);
            
            // Xử lý từng pixel của QR để làm trong suốt phần nền trắng
            const qrData = processedQRCtx.getImageData(0, 0, processedQR.width, processedQR.height);
            const qrPixels = qrData.data;
            
            // Xử lý nền trắng thành trong suốt
            for (let i = 0; i < qrPixels.length; i += 4) {
                const red = qrPixels[i];
                const green = qrPixels[i + 1];
                const blue = qrPixels[i + 2];
                
                // Giảm ngưỡng để bắt được nhiều pixel trắng/gần trắng hơn
                if (red > 180 && green > 180 && blue > 180) {
                    qrPixels[i + 3] = 0; // Alpha = 0 (trong suốt)
                }
                // Tăng cường màu đỏ cho QR
                else if (red > 100) {
                    qrPixels[i] = 231; // Red
                    qrPixels[i+1] = 38; // Green
                    qrPixels[i+2] = 38; // Blue
                }
            }
            
            // Đưa dữ liệu đã xử lý trở lại canvas
            processedQRCtx.putImageData(qrData, 0, 0);

            // Create a canvas for the final image
            const finalCanvas = document.createElement('canvas');
            const ctx = finalCanvas.getContext('2d');

            // Load the heart image
            const heartImg = new Image();
            heartImg.onload = function () {
                // Set canvas to high resolution with padding for caption
                const scale = 2; // For better quality
                const captionHeight = 80; // Fixed height for caption area

                finalCanvas.width = heartImg.width * scale;
                finalCanvas.height = (heartImg.height + captionHeight) * scale;
                ctx.scale(scale, scale);

                // Draw heart background với nền trong suốt
                ctx.drawImage(heartImg, 0, 0);

                // Use fixed QR size based on image dimensions (not screen size)
                const qrSize = Math.min(heartImg.width, heartImg.height) * 0.40;

                // Calculate QR position (slightly above center)
                const centerX = heartImg.width / 2;
                const centerY = heartImg.height * 0.533;

                // Draw QR diamond with QR có nền trong suốt
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(Math.PI / 4);

                // Draw QR đã xử lý (không có nền trắng)
                ctx.drawImage(processedQR, -qrSize / 2, -qrSize / 2, qrSize, qrSize);
                ctx.restore();

                // Thêm chú thích vào hình ảnh - VỊ TRÍ CỐ ĐỊNH
                const caption = document.getElementById('captionText').value;
                const font = document.getElementById('fontSelect').value;
                if (caption) {
                    ctx.save();

                    // Thiết lập font với kích thước lớn hơn
                    const fontSize = Math.round(heartImg.width / 12); // Tăng cỡ chữ (giảm số chia từ 20 xuống 12)
                    ctx.font = `bold ${fontSize}px ${font}`;
                    ctx.textAlign = 'center';
                    ctx.fillStyle = 'rgb(231,38,38)';
                    ctx.textBaseline = 'middle';

                    // VỊ TRÍ CỐ ĐỊNH: luôn cách đáy ảnh gốc 40px
                    const textX = heartImg.width / 2; // Giữa theo chiều ngang
                    const textY = heartImg.height + 40; // Cách đáy ảnh gốc 40px

                    // Vẽ chữ
                    ctx.fillText(caption, textX, textY, heartImg.width * 0.9);

                    ctx.restore();
                }

                // Download the final image
                finalCanvas.toBlob(function (blob) {
                    const url = URL.createObjectURL(blob);
                    // Hiển thị ảnh cho người dùng nhấn giữ lưu
                    let imgPreview = document.getElementById('imgPreview');
                    if (!imgPreview) {
                        imgPreview = document.createElement('img');
                        imgPreview.id = 'imgPreview';
                        imgPreview.style.maxWidth = '100%';
                        imgPreview.style.marginTop = '18px';
                        imgPreview.alt = 'Ảnh QR trái tim';
                        document.querySelector('.container').appendChild(imgPreview);
                    }
                    imgPreview.src = url;

                    // Tải tự động như cũ (nếu trình duyệt hỗ trợ)
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `qr-heart-${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    setTimeout(() => URL.revokeObjectURL(url), 2000);
                    
                    // Hiển thị dialog cảm ơn sau khi tải xuống hoàn tất
                    showThankDialog();
                }, 'image/png', 1.0);
            };

            heartImg.src = heartImageData;
        }

        // Chia sẻ/lưu ảnh bằng Web Share API (ưu tiên cho iPhone/Android)
        async function shareImage() {
            try {
                const qrCanvas = document.getElementById('qrCanvas');
                if (!qrCanvas || !qrCanvas.width) {
                    // Nếu chưa có QR thì tạo trước, và bỏ hiện dialog cảm ơn tự động
                    generateQR({ suppressThank: true });
                }

                // Xử lý QR để có nền trong suốt (giống downloadImage)
                const processedQR = document.createElement('canvas');
                const processedQRCtx = processedQR.getContext('2d');
                processedQR.width = qrCanvas.width;
                processedQR.height = qrCanvas.height;
                processedQRCtx.drawImage(qrCanvas, 0, 0);

                const qrData = processedQRCtx.getImageData(0, 0, processedQR.width, processedQR.height);
                const qrPixels = qrData.data;
                for (let i = 0; i < qrPixels.length; i += 4) {
                    const r = qrPixels[i];
                    const g = qrPixels[i + 1];
                    const b = qrPixels[i + 2];
                    if (r > 180 && g > 180 && b > 180) {
                        qrPixels[i + 3] = 0;
                    } else if (r > 100) {
                        qrPixels[i] = 231;
                        qrPixels[i + 1] = 38;
                        qrPixels[i + 2] = 38;
                    }
                }
                processedQRCtx.putImageData(qrData, 0, 0);

                // Kết hợp vào ảnh trái tim giống downloadImage nhưng trả ra blob để chia sẻ
                const finalCanvas = document.createElement('canvas');
                const ctx = finalCanvas.getContext('2d');
                const heartImg = new Image();
                await new Promise((resolve, reject) => {
                    heartImg.onload = resolve;
                    heartImg.onerror = reject;
                    heartImg.src = heartImageData;
                });

                const scale = 2;
                const captionHeight = 80;
                finalCanvas.width = heartImg.width * scale;
                finalCanvas.height = (heartImg.height + captionHeight) * scale;
                ctx.scale(scale, scale);
                ctx.drawImage(heartImg, 0, 0);

                const qrSize = Math.min(heartImg.width, heartImg.height) * 0.40;
                const centerX = heartImg.width / 2;
                const centerY = heartImg.height * 0.533;
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(Math.PI / 4);
                ctx.drawImage(processedQR, -qrSize / 2, -qrSize / 2, qrSize, qrSize);
                ctx.restore();

                const caption = document.getElementById('captionText').value;
                const font = document.getElementById('fontSelect').value;
                if (caption) {
                    ctx.save();
                    const fontSize = Math.round(heartImg.width / 12);
                    ctx.font = `bold ${fontSize}px ${font}`;
                    ctx.textAlign = 'center';
                    ctx.fillStyle = 'rgb(231,38,38)';
                    ctx.textBaseline = 'middle';
                    const textX = heartImg.width / 2;
                    const textY = heartImg.height + 40;
                    ctx.fillText(caption, textX, textY, heartImg.width * 0.9);
                    ctx.restore();
                }

                const blob = await new Promise(resolve => finalCanvas.toBlob(resolve, 'image/png', 1.0));

                const file = new File([blob], `qr-heart-${Date.now()}.png`, { type: 'image/png' });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'QR Trái tim',
                        text: caption || 'Ảnh QR trái tim'
                    });
                    showThankDialog();
                    return;
                }

                // Fallback: nếu không hỗ trợ share file, thử share URL (ít trình duyệt hỗ trợ blob URL)
                if (navigator.share) {
                    const tmpUrl = URL.createObjectURL(blob);
                    try {
                        await navigator.share({ title: 'QR Trái tim', url: tmpUrl });
                        showThankDialog();
                        return;
                    } catch (e) {
                        // bỏ qua để rơi xuống fallback tiếp theo
                    } finally {
                        setTimeout(() => URL.revokeObjectURL(tmpUrl), 1500);
                    }
                }

                // Fallback cuối: dùng cơ chế tải hiện có và hiển thị preview để người dùng lưu tay
                const url = URL.createObjectURL(blob);
                let imgPreview = document.getElementById('imgPreview');
                if (!imgPreview) {
                    imgPreview = document.createElement('img');
                    imgPreview.id = 'imgPreview';
                    imgPreview.style.maxWidth = '100%';
                    imgPreview.style.marginTop = '18px';
                    imgPreview.alt = 'Ảnh QR trái tim';
                    document.querySelector('.container').appendChild(imgPreview);
                }
                imgPreview.src = url;

                // Thêm link tải như dự phòng
                const a = document.createElement('a');
                a.href = url;
                a.download = `qr-heart-${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 2000);
                showThankDialog();
            } catch (err) {
                console.error('Share image error:', err);
                // Nếu có lỗi, rơi về download tiêu chuẩn
                downloadImage();
            }
        }

        // Hàm chuẩn bị cho chức năng tạo hình nền tùy chỉnh
        function prepareCustomBackground() {
            // Tạo QR trước nếu chưa có
            if (document.getElementById('heartContainer').style.display !== 'block') {
                generateQR();
                return;
            }
            
            // Tạo ảnh QR trái tim để sử dụng
            createQROverlayImage(function(qrImageUrl) {
                // Lưu URL ảnh QR để sử dụng sau
                window._qrImageUrl = qrImageUrl;
                
                // Mở modal chọn ảnh nền
                document.getElementById('customBgModal').style.display = 'flex';
            });
        }
        
        // Hàm tạo ảnh QR trái tim (tương tự downloadImage nhưng chỉ trả về URL)
        function createQROverlayImage(callback) {
            const heartContainer = document.getElementById('heartContainer');
            const qrCanvas = document.getElementById('qrCanvas');
            
            // Trước tiên, xử lý QR code để loại bỏ nền trắng
            const processedQR = document.createElement('canvas');
            const processedQRCtx = processedQR.getContext('2d');
            
            // Đặt kích thước để phù hợp với QR code
            processedQR.width = qrCanvas.width;
            processedQR.height = qrCanvas.height;
            
            // Vẽ QR lên canvas tạm
            processedQRCtx.drawImage(qrCanvas, 0, 0);
            
            // Xử lý từng pixel của QR để làm trong suốt phần nền trắng
            const qrData = processedQRCtx.getImageData(0, 0, processedQR.width, processedQR.height);
            const data = qrData.data;
            
            // Xử lý nền trắng thành trong suốt
            for (let i = 0; i < data.length; i += 4) {
                const red = data[i];
                const green = data[i + 1];
                const blue = data[i + 2];
                
                // Giảm ngưỡng để bắt được nhiều pixel trắng/gần trắng hơn
                if (red > 180 && green > 180 && blue > 180) {
                    data[i + 3] = 0; // Alpha = 0 (trong suốt)
                } 
                // Tăng cường màu đỏ cho QR
                else if (red > 100) {
                    data[i] = 231; // Red
                    data[i+1] = 38; // Green
                    data[i+2] = 38; // Blue
                }
            }
            
            // Đưa dữ liệu đã xử lý trở lại canvas
            processedQRCtx.putImageData(qrData, 0, 0);
            
            // Tạo canvas cho ảnh cuối cùng
            const finalCanvas = document.createElement('canvas');
            const ctx = finalCanvas.getContext('2d');
            
            // Load ảnh trái tim
            const heartImg = new Image();
            heartImg.crossOrigin = 'Anonymous';
            
            heartImg.onload = function() {
                // Thiết lập canvas với độ phân giải cao
                const scale = 2; // Cho chất lượng tốt hơn
                const captionHeight = 80; // Chiều cao cố định cho phần chú thích
                
                finalCanvas.width = heartImg.width * scale;
                finalCanvas.height = (heartImg.height + captionHeight) * scale;
                ctx.scale(scale, scale);
                
                // Vẽ nền trái tim
                ctx.drawImage(heartImg, 0, 0);
                
                // Sử dụng kích thước QR cố định dựa trên kích thước hình ảnh
                const qrSize = Math.min(heartImg.width, heartImg.height) * 0.40;
                
                // Tính toán vị trí QR (hơi cao hơn tâm)
                const centerX = heartImg.width / 2;
                const centerY = heartImg.height * 0.533;
                
                // Vẽ QR đã xử lý nền trong suốt vào vị trí đúng
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(Math.PI / 4);
                
                // Sử dụng chế độ kết hợp để chỉ vẽ phần không trong suốt
                ctx.globalCompositeOperation = 'source-over';
                
                // Vẽ QR đã xử lý nền trong suốt (không có nền trắng nữa)
                ctx.drawImage(processedQR, -qrSize / 2, -qrSize / 2, qrSize, qrSize);
                ctx.restore();
                
                // Thêm chú thích vào hình ảnh (vị trí cố định)
                const caption = document.getElementById('captionText').value;
                const font = document.getElementById('fontSelect').value;
                if (caption) {
                    ctx.save();
                    
                    const fontSize = Math.round(heartImg.width / 12); // Tăng cỡ chữ (giảm số chia từ 20 xuống 12)
                    ctx.font = `bold ${fontSize}px ${font}`;
                    ctx.textAlign = 'center';
                    ctx.fillStyle = 'rgb(231,38,38)';
                    ctx.textBaseline = 'middle';
                    
                    const textX = heartImg.width / 2;
                    const textY = heartImg.height + 40;
                    
                    ctx.fillText(caption, textX, textY, heartImg.width * 0.9);
                    
                    ctx.restore();
                }
                
                // Trả về URL của ảnh
                const imageUrl = finalCanvas.toDataURL('image/png');
                callback(imageUrl);
            };
            
            heartImg.src = heartImageData;
        }
        
        // Khởi tạo chức năng chỉnh sửa ảnh nền
        function initBackgroundEditor() {
            const closeBtn = document.getElementById('closeCustomBgModal');
            const bgImageInput = document.getElementById('bgImageInput');
            const bgSelectArea = document.getElementById('bgSelectArea');
            const bgEditorArea = document.getElementById('bgEditorArea');
            const userBgImage = document.getElementById('userBgImage');
            const qrOverlayImage = document.getElementById('qrOverlayImage');
            const saveCustomBgBtn = document.getElementById('saveCustomBgBtn');
            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            const centerQrBtn = document.getElementById('centerQrBtn');
            const bgPreviewContainer = document.getElementById('bgPreviewContainer');
            
            // Biến theo dõi trạng thái chỉnh sửa
            let qrScale = 1.0;
            let isDragging = false; // Biến cho việc kéo QR
            let offsetX = 0, offsetY = 0;
            
            // Biến lưu trữ trạng thái icon
            let activeIcon = null; // Icon đang được tương tác
            let icons = []; // Mảng các icon đã thêm
            let isIconDragging = false; // Biến riêng cho kéo icon
            let isResizing = false;
            let iconStartX, iconStartY; // Tọa độ bắt đầu kéo icon
            let startWidth, startHeight; // Kích thước ban đầu khi resize
            let lastTouches = null; // Lưu trạng thái touch events trước đó
            
            // Nút hiển thị/ẩn danh sách icon
            const toggleIconsBtn = document.getElementById('toggleIconsBtn');
            const iconsSelector = document.getElementById('iconsSelector');
            
            toggleIconsBtn.addEventListener('click', function() {
                if (iconsSelector.style.display === 'none') {
                    iconsSelector.style.display = 'block';
                } else {
                    iconsSelector.style.display = 'none';
                }
            });
            
            // Hàm tạo element icon mới
            function createIconElement(src) {
                const iconContainer = document.createElement('div');
                iconContainer.className = 'icon-container';
                iconContainer.style.position = 'absolute';
                iconContainer.style.display = 'inline-block';
                
                // Lưu giá trị xoay mặc định
                iconContainer.rotation = 0;
                
                const icon = document.createElement('img');
                icon.src = src;
                icon.className = 'custom-icon';
                icon.style.width = '80px';
                icon.style.height = 'auto';
                icon.style.cursor = 'move';
                icon.style.userSelect = 'none';
                icon.style.touchAction = 'none';
                icon.style.transform = 'rotate(0deg)';
                
                // Thêm nút X để xóa icon
                const deleteBtn = document.createElement('div');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.className = 'delete-icon-btn';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '-8px';
                deleteBtn.style.right = '-8px';
                deleteBtn.style.width = '20px';
                deleteBtn.style.height = '20px';
                deleteBtn.style.background = 'rgba(255, 0, 0, 0.8)';
                deleteBtn.style.color = 'white';
                deleteBtn.style.borderRadius = '50%';
                deleteBtn.style.textAlign = 'center';
                deleteBtn.style.lineHeight = '18px';
                deleteBtn.style.fontWeight = 'bold';
                deleteBtn.style.fontSize = '16px';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.style.zIndex = '101';
                deleteBtn.style.boxShadow = '0 0 3px rgba(0, 0, 0, 0.5)';
                
                // Thêm nút xoay icon
                const rotateBtn = document.createElement('div');
                rotateBtn.innerHTML = '&#8635;'; // Unicode ký hiệu xoay
                rotateBtn.className = 'rotate-icon-btn';
                rotateBtn.style.position = 'absolute';
                rotateBtn.style.top = '-8px';
                rotateBtn.style.left = '-8px';
                rotateBtn.style.width = '20px';
                rotateBtn.style.height = '20px';
                rotateBtn.style.background = 'rgba(0, 123, 255, 0.8)';
                rotateBtn.style.color = 'white';
                rotateBtn.style.borderRadius = '50%';
                rotateBtn.style.textAlign = 'center';
                rotateBtn.style.lineHeight = '20px';
                rotateBtn.style.fontWeight = 'bold';
                rotateBtn.style.fontSize = '16px';
                rotateBtn.style.cursor = 'pointer';
                rotateBtn.style.zIndex = '101';
                rotateBtn.style.boxShadow = '0 0 3px rgba(0, 0, 0, 0.5)';
                
                // Xử lý sự kiện khi click vào nút X
                deleteBtn.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Xóa icon khỏi container và mảng icons
                    bgPreviewContainer.removeChild(iconContainer);
                    
                    // Xóa khỏi mảng icons
                    const index = icons.indexOf(iconContainer);
                    if (index > -1) {
                        icons.splice(index, 1);
                    }
                    
                    // Nếu icon đang được chọn, đặt lại activeIcon
                    if (activeIcon === iconContainer) {
                        activeIcon = null;
                    }
                });
                
                // Xử lý sự kiện khi click vào nút xoay
                rotateBtn.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Xoay thêm 45 độ
                    iconContainer.rotation = (iconContainer.rotation + 45) % 360;
                    icon.style.transform = `rotate(${iconContainer.rotation}deg)`;
                });
                
                // Thêm resize handle vào góc phải dưới
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';
                resizeHandle.style.position = 'absolute';
                resizeHandle.style.width = '20px';
                resizeHandle.style.height = '20px';
                resizeHandle.style.bottom = '0';
                resizeHandle.style.right = '0';
                resizeHandle.style.cursor = 'nwse-resize';
                resizeHandle.style.background = 'rgba(0,0,0,0.2)';
                resizeHandle.style.borderRadius = '50%';
                resizeHandle.style.zIndex = '10';
                
                // Thêm các thành phần vào container
                iconContainer.appendChild(icon);
                iconContainer.appendChild(deleteBtn);
                iconContainer.appendChild(rotateBtn);
                iconContainer.appendChild(resizeHandle);
                
                // Thêm container vào bgPreviewContainer
                bgPreviewContainer.appendChild(iconContainer);
                
                // Căn vị trí icon ở giữa container
                const containerRect = bgPreviewContainer.getBoundingClientRect();
                iconContainer.style.left = ((containerRect.width - 80) / 2) + 'px';
                iconContainer.style.top = ((containerRect.height - 80) / 2) + 'px';
                
                // Thêm sự kiện tương tác
                icon.addEventListener('mousedown', (e) => startIconInteraction(e, iconContainer));
                icon.addEventListener('touchstart', (e) => startIconInteraction(e, iconContainer));
                
                resizeHandle.addEventListener('mousedown', (e) => startIconResize(e, iconContainer));
                resizeHandle.addEventListener('touchstart', (e) => startIconResize(e, iconContainer));
                
                return iconContainer;
            }
            
            // Cập nhật vị trí của resize handle theo icon
            function updateResizeHandlePosition(iconContainer) {
                const icon = iconContainer.querySelector('.custom-icon');
                const handle = iconContainer.querySelector('.resize-handle');
                
                // Handle có vị trí tương đối so với iconContainer nên không cần điều chỉnh
            }
            
            // Xử lý khi chọn icon
            const iconOptions = document.querySelectorAll('.icon-option');
            
            iconOptions.forEach(iconOption => {
                iconOption.addEventListener('click', function() {
                    const iconContainer = createIconElement(this.src);
                    icons.push(iconContainer);
                    
                    // Đánh dấu icon đã chọn
                    iconOption.style.border = '3px solid #4ecdc4';
                    
                    // Tự động bỏ viền sau 1 giây
                    setTimeout(() => {
                        iconOption.style.border = 'none';
                    }, 1000);
                });
            });
            
            // Xử lý khi nhấn nút xóa icon
            document.getElementById('removeIconBtn').addEventListener('click', function() {
                if (activeIcon) {
                    // Xóa icon khỏi container
                    bgPreviewContainer.removeChild(activeIcon);
                    
                    // Xóa khỏi mảng icons
                    const index = icons.indexOf(activeIcon);
                    if (index > -1) {
                        icons.splice(index, 1);
                    }
                    
                    activeIcon = null;
                } else {
                    alert('Vui lòng chọn một icon trước!');
                }
            });
            
            // Bắt đầu tương tác với icon (kéo hoặc resize)
            function startIconInteraction(e, iconContainer) {
                e.preventDefault();
                e.stopPropagation();
                
                // Thiết lập icon đang hoạt động
                if (activeIcon && activeIcon !== iconContainer) {
                    // Bỏ viền icon trước đó
                    activeIcon.querySelector('.custom-icon').style.border = 'none';
                }
                
                activeIcon = iconContainer;
                activeIcon.querySelector('.custom-icon').style.border = '2px dashed #4ecdc4';
                activeIcon.style.zIndex = '100'; // Đưa lên trên cùng
                
                isIconDragging = true;
                isResizing = false;
                isDragging = false; // Đảm bảo không kéo QR
                
                if (e.type === 'mousedown') {
                    iconStartX = e.clientX;
                    iconStartY = e.clientY;
                } else {
                    iconStartX = e.touches[0].clientX;
                    iconStartY = e.touches[0].clientY;
                    
                    // Lưu trạng thái touch cho pinch-zoom
                    if (e.touches.length === 2) {
                        lastTouches = e.touches;
                    }
                }
                
                // Lưu offset cho kéo icon
                const rect = iconContainer.getBoundingClientRect();
                iconContainer.offsetX = iconStartX - rect.left;
                iconContainer.offsetY = iconStartY - rect.top;
                
            }
            
            // Bắt đầu thay đổi kích thước icon
            function startIconResize(e, iconContainer) {
                e.preventDefault();
                e.stopPropagation();
                
                activeIcon = iconContainer;
                activeIcon.querySelector('.custom-icon').style.border = '2px dashed #4ecdc4';
                
                isIconDragging = false;
                isResizing = true;
                isDragging = false; // Đảm bảo không kéo QR
                
                if (e.type === 'mousedown') {
                    iconStartX = e.clientX;
                    iconStartY = e.clientY;
                } else {
                    iconStartX = e.touches[0].clientX;
                    iconStartY = e.touches[0].clientY;
                }
                
                // Lưu kích thước ban đầu
                const rect = iconContainer.getBoundingClientRect();
                startWidth = rect.width;
                startHeight = rect.height;
                
                console.log('Start resize icon container');
            }
            
            // Xử lý kéo icon
            function dragIcon(clientX, clientY) {
                if (!activeIcon || !isIconDragging) return;
                
                const containerRect = bgPreviewContainer.getBoundingClientRect();
                
                // Tính toán vị trí mới - không giới hạn trong container
                let newLeft = clientX - containerRect.left - activeIcon.offsetX;
                let newTop = clientY - containerRect.top - activeIcon.offsetY;
                
                // Cập nhật vị trí không giới hạn
                activeIcon.style.left = newLeft + 'px';
                activeIcon.style.top = newTop + 'px';
                
            }
            
            // Xử lý resize icon - loại bỏ giới hạn kích thước tối đa
            function resizeIcon(clientX, clientY) {
                if (!activeIcon || !isResizing) return;
                
                const iconContainer = activeIcon;
                const icon = iconContainer.querySelector('.custom-icon');
                const rect = iconContainer.getBoundingClientRect();
                
                // Tính toán kích thước mới dựa trên vị trí con trỏ
                const width = Math.max(30, clientX - rect.left + 10);
                
                // Cập nhật kích thước (không giới hạn kích thước tối đa)
                icon.style.width = width + 'px';
                
            }
            
            // Vẽ tất cả các icon khi lưu ảnh - cập nhật để áp dụng xoay
            function drawIcons(ctx, containerRect) {
                // Không cần mở rộng canvas - phần nào lòi ra ngoài sẽ tự động bị cắt
                
                icons.forEach(iconContainer => {
                    if (!iconContainer) return; // Skip nếu icon không hợp lệ
                    
                    try {
                        const icon = iconContainer.querySelector('.custom-icon');
                        if (!icon) return; // Skip nếu không tìm thấy icon
                        
                        const iconLeft = parseFloat(iconContainer.style.left) || 0;
                        const iconTop = parseFloat(iconContainer.style.top) || 0;
                        const rotation = iconContainer.rotation || 0;
                        
                        // Lưu trạng thái context hiện tại
                        ctx.save();
                        
                        // Di chuyển đến vị trí trung tâm của icon
                        const iconWidth = icon.offsetWidth;
                        const iconHeight = icon.offsetHeight;
                        const centerX = iconLeft + iconWidth/2;
                        const centerY = iconTop + iconHeight/2;
                        
                        // Áp dụng xoay từ tâm của icon
                        ctx.translate(centerX, centerY);
                        ctx.rotate(rotation * Math.PI / 180);
                        
                        // Vẽ icon (không vẽ viền, nút X và handle)
                        ctx.drawImage(icon, -iconWidth/2, -iconHeight/2, iconWidth, iconHeight);
                        
                        // Khôi phục trạng thái context
                        ctx.restore();
                    } catch (err) {
                        console.error('Lỗi khi vẽ icon:', err);
                    }
                });
            }
            
            // Xóa bỏ nút "Xóa icon đã chọn" và thay đổi giao diện phần chọn icon
            document.getElementById('iconsSelector').innerHTML = `
                <h3 style="margin-bottom: 10px; font-size: 1rem; text-align: left;">Chọn icon:</h3>
                <div style="
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 10px;
                    max-height: 200px;
                    overflow-y: auto;
                    padding: 5px;
                ">
                    <img src="./icon_qr/icon_qr (1).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (2).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (3).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (4).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (5).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (6).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (7).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (8).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (9).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (10).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (11).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (12).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (13).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (14).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (15).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (16).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (17).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (18).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (19).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr (21).png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                    <img src="./icon_qr/icon_qr.png" class="icon-option" style="width: 100%; height: auto; cursor: pointer; border-radius: 5px;">
                </div>
            `;
            
            // Cập nhật các sự kiện khi chọn icon từ danh sách
            const updateIconSelectionEvents = function() {
                const iconOptions = document.querySelectorAll('.icon-option');
                
                iconOptions.forEach(iconOption => {
                    // Xóa event listener cũ nếu có
                    iconOption.replaceWith(iconOption.cloneNode(true));
                });
                
                // Thêm lại event listener mới
                document.querySelectorAll('.icon-option').forEach(iconOption => {
                    iconOption.addEventListener('click', function() {
                        const iconContainer = createIconElement(this.src);
                        icons.push(iconContainer);
                        
                        // Đánh dấu icon đã chọn
                        iconOption.style.border = '3px solid #4ecdc4';
                        
                        // Tự động bỏ viền sau 1 giây
                        setTimeout(() => {
                            iconOption.style.border = 'none';
                        }, 1000);
                    });
                });
            };
            
            // Cập nhật các sự kiện sau khi thay đổi HTML
            updateIconSelectionEvents();
            
            // Đóng modal
            closeBtn.addEventListener('click', function() {
                document.getElementById('customBgModal').style.display = 'none';
            });
            
            // Xử lý khi người dùng chọn file ảnh nền
            bgImageInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        userBgImage.src = e.target.result;
                        
                        // Hiển thị phần chỉnh sửa
                        bgSelectArea.style.display = 'none';
                        bgEditorArea.style.display = 'block';
                        
                        // Điều chỉnh kích thước container theo tỉ lệ ảnh
                        const img = new Image();
                        img.onload = function() {
                            // Lấy kích thước thực của ảnh
                            const imgWidth = this.width;
                            const imgHeight = this.height;
                            
                            // Tính toán tỉ lệ ảnh
                            const containerWidth = bgPreviewContainer.offsetWidth;
                            const aspectRatio = imgHeight / imgWidth;
                            
                            // Điều chỉnh chiều cao của container theo tỉ lệ ảnh
                            bgPreviewContainer.style.height = (containerWidth * aspectRatio) + 'px';
                            
                            // Khởi tạo hình QR overlay
                            qrOverlayImage.src = window._qrImageUrl;
                            
                            // Đặt vị trí ban đầu ở giữa
                            setTimeout(centerQROverlay, 100);
                        };
                        img.src = e.target.result;
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            // Di chuyển QR overlay bằng chuột/chạm
            qrOverlayImage.addEventListener('mousedown', startQrDrag);
            qrOverlayImage.addEventListener('touchstart', startQrDrag);
            
            // Xử lý sự kiện di chuyển QR riêng biệt
            function startQrDrag(e) {
                e.preventDefault();
                e.stopPropagation(); // Ngăn sự kiện lan truyền
                
                isDragging = true;
                isIconDragging = false; // Đảm bảo không kéo icon
                
                if (e.type === 'mousedown') {
                    iconStartX = e.clientX;
                    iconStartY = e.clientY;
                } else {
                    iconStartX = e.touches[0].clientX;
                    iconStartY = e.touches[0].clientY;
                }
                
                // Lưu vị trí hiện tại
                const rect = qrOverlayImage.getBoundingClientRect();
                offsetX = iconStartX - rect.left;
                offsetY = iconStartY - rect.top;
            }
            
            // Hàm kéo QR
            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();
                e.stopPropagation(); // Ngăn sự kiện lan truyền
                
                let clientX, clientY;
                
                if (e.type === 'mousemove') {
                    clientX = e.clientX;
                    clientY = e.clientY;
                } else {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                }
                
                const containerRect = bgPreviewContainer.getBoundingClientRect();
                
                // Tính toán vị trí mới - không giới hạn bởi container
                let newLeft = clientX - containerRect.left - offsetX;
                let newTop = clientY - containerRect.top - offsetY;
                
                // Cập nhật vị trí không giới hạn
                qrOverlayImage.style.left = newLeft + 'px';
                qrOverlayImage.style.top = newTop + 'px';
            }
            
            // Hàm dừng kéo QR
            function stopDrag() {
                isDragging = false;
            }

            document.addEventListener('mousemove', function(e) {
                // Xử lý kéo QR
                if (isDragging) {
                    drag(e);
                    return;
                }
                
                // Xử lý kéo icon
                if (isIconDragging && activeIcon) {
                    e.preventDefault();
                    dragIcon(e.clientX, e.clientY);
                    return;
                }
                
                // Xử lý resize icon
                if (isResizing && activeIcon) {
                    e.preventDefault();
                    resizeIcon(e.clientX, e.clientY);
                    return;
                }
            });

            document.addEventListener('touchmove', function(e) {
                // Xử lý kéo QR
                if (isDragging) {
                    drag(e);
                    return;
                }
                
                if (!e.touches || e.touches.length === 0) return;
                
                const touch = e.touches[0];
                
                // Xử lý kéo icon
                if (isIconDragging && activeIcon) {
                    e.preventDefault();
                    dragIcon(touch.clientX, touch.clientY);
                    return;
                }
                
                // Xử lý resize icon
                if (isResizing && activeIcon) {
                    e.preventDefault();
                    resizeIcon(touch.clientX, touch.clientY);
                    return;
                }
                
                // Xử lý pinch-zoom
                if (e.touches.length === 2 && activeIcon) {
                    e.preventDefault();
                    const icon = activeIcon.querySelector('.custom-icon');
                    
                    // Tính khoảng cách giữa hai ngón tay
                    const dist = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    
                    // Nếu đây là lần đầu tiên pinch-zoom
                    if (!lastTouches) {
                        lastTouches = {
                            dist: dist,
                            width: parseFloat(icon.style.width) || 80
                        };
                        return;
                    }
                    
                    // Tính tỷ lệ thay đổi
                    const scale = dist / lastTouches.dist;
                    const newWidth = Math.max(30, Math.min(lastTouches.width * scale, bgPreviewContainer.offsetWidth * 0.8));
                    
                    // Cập nhật kích thước
                    icon.style.width = newWidth + 'px';
                    return;
                }
            });

            // Xử lý kết thúc tương tác
            function stopInteraction() {
                isIconDragging = false;
                isResizing = false;
                // Không reset activeIcon để giữ trạng thái icon đang được chọn
            }
            
            document.addEventListener('mouseup', function() {
                stopDrag();
                stopInteraction();
            });
            
            document.addEventListener('touchend', function() {
                stopDrag();
                stopInteraction();
                
                // Reset biến lastTouches cho pinch-zoom
                lastTouches = null;
            });
            
            // Nút zoom in/out
            zoomInBtn.addEventListener('click', function() {
                qrScale += 0.1;
                updateQRScale();
            });
            
            zoomOutBtn.addEventListener('click', function() {
                if (qrScale > 0.5) {
                    qrScale -= 0.1;
                    updateQRScale();
                }
            });
            
            // Nút căn giữa
            centerQrBtn.addEventListener('click', centerQROverlay);
            
            // Nút chọn ảnh khác
            document.getElementById('changeImageBtn').addEventListener('click', function() {
                // Ẩn phần chỉnh sửa và hiển thị lại phần chọn ảnh
                bgEditorArea.style.display = 'none';
                bgSelectArea.style.display = 'block';
                
                // Xóa giá trị của input file để có thể chọn lại cùng một ảnh nếu muốn
                document.getElementById('bgImageInput').value = '';
            });
            
            // Nút lưu ảnh
            saveCustomBgBtn.addEventListener('click', saveCustomBackground);
            
            // Cập nhật kích thước QR
            function updateQRScale() {
                const baseSize = 200; // Kích thước cơ bản
                const newSize = baseSize * qrScale;
                qrOverlayImage.style.width = newSize + 'px';
            }
            
            // Căn giữa QR
            function centerQROverlay() {
                const containerRect = bgPreviewContainer.getBoundingClientRect();
                const qrRect = qrOverlayImage.getBoundingClientRect();
                
                const left = (containerRect.width - qrRect.width) / 2;
                const top = (containerRect.height - qrRect.height) / 2;
                
                qrOverlayImage.style.left = left + 'px';
                qrOverlayImage.style.top = top + 'px';
            }
            
            // Lưu ảnh đã chỉnh sửa
            function saveCustomBackground() {
                // Tạo canvas để kết hợp ảnh
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Lấy kích thước container
                const containerRect = bgPreviewContainer.getBoundingClientRect();
                
                // Chỉ lưu phần trong container, phần lòi ra sẽ bị cắt
                const canvasWidth = containerRect.width;
                const canvasHeight = containerRect.height;
                
                // Thiết lập kích thước canvas, với tỷ lệ x2 cho độ phân giải cao
                canvas.width = canvasWidth * 2;
                canvas.height = canvasHeight * 2;
                
                // Scale canvas để tăng độ phân giải
                ctx.scale(2, 2);
                
                // Thiết lập vùng cắt - chỉ hiển thị phần trong container
                ctx.beginPath();
                ctx.rect(0, 0, canvasWidth, canvasHeight);
                ctx.clip();
                
                // Vẽ ảnh nền giữ nguyên tỉ lệ
                ctx.drawImage(userBgImage, 0, 0, containerRect.width, containerRect.height);
                
                // Vẽ QR overlay
                const left = parseFloat(qrOverlayImage.style.left) || 0;
                const top = parseFloat(qrOverlayImage.style.top) || 0;
                const width = qrOverlayImage.offsetWidth;
                const height = qrOverlayImage.offsetHeight;
                
                ctx.drawImage(qrOverlayImage, left, top, width, height);
                
                // Vẽ tất cả các icon đã thêm
                drawIcons(ctx, containerRect);
                
                // Tạo URL và tải xuống
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `qr-custom-background-${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    setTimeout(() => URL.revokeObjectURL(url), 2000);
                    
                    // Đóng modal sau khi tải
                    document.getElementById('customBgModal').style.display = 'none';
                    
                    // // Hiển thị thông báo
                    // alert('Đã lưu ảnh thành công!');
                    
               // Hiển thị dialog cảm ơn sau khi tải xuống hoàn tất
setTimeout(() => {
    document.getElementById('thankDialog').style.display = 'flex';
}, 500);
                }, 'image/png', 1.0);
            }
        }
        
        // Các hàm xử lý DOM và sự kiện
        document.getElementById('captionText').addEventListener('input', updateCaptionDisplay);
        document.getElementById('fontSelect').addEventListener('change', updateCaptionDisplay);

        // Allow Enter key to generate QR
        document.getElementById('qrText').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                generateQR();
            }
        });

        // Auto load when page loads
        window.addEventListener('load', function () {
            const heartContainer = document.getElementById('heartContainer');
            heartContainer.style.backgroundImage = `url(${heartImageData})`;
            
            // Kiểm tra xem thư viện QR code đã được load chưa
            if (typeof qrcode === 'undefined') {
                console.warn('QR code library not loaded yet, retrying...');
                // Thử load lại thư viện nếu cần
                setTimeout(() => {
                    if (typeof qrcode === 'undefined') {
                        console.error('QR code library failed to load');
                    }
                }, 2000);
            }
        });

        // Load QR from URL parameter
        window.addEventListener('DOMContentLoaded', function () {
            // Khởi tạo chức năng chỉnh sửa ảnh nền
            initBackgroundEditor();
            
            // Đóng modal khi click ra ngoài
            document.getElementById('customBgModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            const params = new URLSearchParams(window.location.search);
            const qr = params.get('qr');
            if (qr) {
                document.getElementById('qrText').value = qr;
                generateQR();
            }
            updateCaptionDisplay(); // Ensure captionDisplay uses the default font
        });

        // Handle window resize
        window.addEventListener('resize', function () {
            // Regenerate QR if it exists to maintain proper sizing
            const qrText = document.getElementById('qrText').value.trim();
            if (qrText && document.getElementById('heartContainer').style.display === 'block') {
                setTimeout(() => generateQR({ suppressThank: true }), 100);
            }
        });

        // Xử lý sự kiện tương tác với icon
        // (Các event listener đã được định nghĩa trong hàm initBackgroundEditor)
    </script>
      
      <button id="toggleSeoBtn" style="margin-bottom:18px;padding:1px 2px;font-size:0.8em;border-radius:12px;color:#908d8d;font-weight:lighter;cursor:pointer;box-shadow:0 2px 8px #0002;background: none;">Xem thêm về HeartQR</button>

      <section class="seo-content" style="display:none;">
        <h2>Món Quà Tặng Độc Đáo Cho Dịp Đặc Biệt</h2>
        <p>Chào mừng bạn đến với công cụ <strong>tạo mã QR hình trái tim</strong> độc đáo! Tạo ra những mã QR đẹp mắt và ý nghĩa để tặng cho người thương, bạn bè, hay sử dụng trong các dịp đặc biệt như sinh nhật, kỷ niệm tình yêu.</p>
        
        <p>Đang tìm kiếm một <strong>món quà sinh nhật độc đáo</strong>? Mã QR hình trái tim là lựa chọn hoàn hảo, kết hợp công nghệ hiện đại với sự lãng mạn. Bạn có thể tùy chỉnh nội dung QR dẫn đến:</p>
        <ul>
          <li>Lời chúc sinh nhật đặc biệt</li>
          <li>Video kỷ niệm hai người</li>
          <li>Playlist nhạc yêu thích</li>
          <li>Album ảnh kỷ niệm</li>
          <li>Link đặt quà hoặc voucher</li>
        </ul>
        
        <h2>Quà Tặng Người Yêu Trong Các Dịp Đặc Biệt</h2>
        <p>Không chỉ dành cho sinh nhật, <strong>QR trái tim</strong> còn là <strong>món quà tặng người yêu</strong> lý tưởng cho Valentine, kỷ niệm quen nhau, hay bất kỳ dịp đặc biệt nào. Hãy tưởng tượng niềm vui khi người ấy quét mã và khám phá thông điệp bất ngờ từ bạn!</p>
      </section>
<section class="more-info" style="display:none;">
        <h2>Tại Sao Nên Chọn QR Trái Tim Làm Quà Tặng?</h2>
        
        <div class="info-card">
            <h3>Ý Nghĩa Và Độc Đáo</h3>
            <p>Mã QR hình trái tim kết hợp công nghệ hiện đại với tình cảm, tạo nên món quà độc đáo mà người nhận khó quên. Khác với những món quà thông thường, QR trái tim mang đến trải nghiệm tương tác đặc biệt.</p>
        </div>
        
        <div class="info-card">
            <h3>Tiết Kiệm Chi Phí</h3>
            <p>Tạo QR trái tim hoàn toàn miễn phí nhưng vẫn mang đến giá trị tinh thần lớn. Bạn có thể đầu tư vào nội dung mã QR dẫn đến (như video, ảnh, lời nhắn) thay vì chi tiền cho những món quà đắt đỏ.</p>
        </div>
        
        <div class="info-card">
            <h3>Bất Ngờ Và Phấn Khích</h3>
            <p>Người nhận sẽ tò mò và phấn khích khi quét mã QR và khám phá nội dung bất ngờ bên trong. Đây là cách tuyệt vời để tạo khoảnh khắc đáng nhớ trong các dịp đặc biệt.</p>
        </div>
        
        <h2>Cách Sử Dụng QR Trái Tim</h2>
        <p>Sau khi tạo <strong>mã QR hình trái tim</strong> của bạn, có nhiều cách để tận dụng:</p>
        <ul>
            <li>In và tặng kèm thiệp sinh nhật hoặc thiệp chúc mừng</li>
            <li>Chia sẻ qua tin nhắn trong các dịp đặc biệt</li>
            <li>Đặt trong khung ảnh mini làm quà lưu niệm</li>
            <li>Sử dụng trong thiết kế thiệp cưới hoặc save-the-date</li>
            <li>Tạo sticker dán vào quà tặng hoặc hộp quà</li>
        </ul>
        
        <div class="faq">
            <h2>Câu Hỏi Thường Gặp</h2>
            
            <div class="faq-item">
                <h3>Tôi có thể lưu mã QR trái tim đã tạo không?</h3>
                <p>Có, bạn có thể tải xuống mã QR trái tim dưới dạng hình ảnh PNG chất lượng cao để in ấn hoặc chia sẻ.</p>
            </div>
            
            <div class="faq-item">
                <h3>Mã QR có hết hạn không?</h3>
                <p>Mã QR không tự hết hạn, nhưng nếu liên kết trong mã QR bị vô hiệu hóa hoặc thay đổi, mã QR sẽ không hoạt động được nữa.</p>
            </div>
            
            <div class="faq-item">
                <h3>Có thể thay đổi màu sắc của QR trái tim không?</h3>
                <p>Hiện tại, mã QR được tạo với màu đỏ phù hợp với hình trái tim. Chúng tôi sẽ cập nhật thêm tùy chọn màu sắc trong tương lai.</p>
            </div>
        </div>
    </section>

    <script>
    // ... existing code ...
    // Toggle SEO content
    document.getElementById('toggleSeoBtn').addEventListener('click', function() {
        var seo = document.querySelector('.seo-content');
        var more = document.querySelector('.more-info');
        var isShow = seo.style.display === 'block';
        seo.style.display = isShow ? 'none' : 'block';
        if(more) more.style.display = isShow ? 'none' : 'block';
        this.textContent = isShow ? 'Xem thêm về HeartQR' : 'Ẩn thông tin HeartQR';
    });
    // ... existing code ...
    </script>
</body>

</html>